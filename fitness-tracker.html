<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FuelStrong</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root {
  --bg: #0b0e13;
  --surface: #111520;
  --card: #161c27;
  --card2: #1c2333;
  --border: #222c3c;
  --accent: #00e5a0;
  --accent2: #ff6b35;
  --accent3: #4da8ff;
  --yellow: #ffd460;
  --purple: #b47fff;
  --text: #dce8f5;
  --muted: #5a6a80;
  --danger: #ff4560;
  --radius: 12px;
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;font-size:14px;overflow-x:hidden;}

/* HEADER */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;gap:12px;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:3px;color:var(--accent);white-space:nowrap;}
.logo span{color:var(--text);}
.header-goals{display:flex;gap:6px;flex-wrap:wrap;}
.goal-chip{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:0.6px;text-transform:uppercase;white-space:nowrap;}
.chip-muscle{background:rgba(0,229,160,0.1);color:var(--accent);border:1px solid rgba(0,229,160,0.2);}
.chip-fat{background:rgba(255,107,53,0.1);color:var(--accent2);border:1px solid rgba(255,107,53,0.2);}
.header-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.date-chip{background:var(--card);border:1px solid var(--border);color:var(--muted);padding:5px 12px;border-radius:8px;font-family:'DM Mono',monospace;font-size:11px;white-space:nowrap;}

/* TABS */
.tabs{background:var(--surface);border-bottom:1px solid var(--border);display:flex;padding:0 20px;overflow-x:auto;}
.tabs::-webkit-scrollbar{height:0;}
.tab{padding:13px 18px;cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;flex-shrink:0;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab:hover:not(.active){color:var(--text);}

/* PANELS */
.panel{display:none;padding:20px;max-width:1400px;margin:0 auto;}
.panel.active{display:block;}

/* GRID */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.span2{grid-column:span 2;}
.span3{grid-column:span 3;}

/* CARDS */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;}
.card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.card-title{font-size:11px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--muted);}

/* STAT TILES */
.stat-tile{background:var(--card2);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;}
.stat-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:5px;}
.stat-val{font-family:'Bebas Neue',sans-serif;font-size:34px;line-height:1;}
.stat-unit{font-size:12px;color:var(--muted);margin-left:3px;}
.stat-sub{font-size:11px;color:var(--muted);margin-top:3px;}

/* RING METERS */
.ring-wrap{position:relative;width:100px;height:100px;margin:0 auto 8px;}
.ring-svg{width:100px;height:100px;transform:rotate(-90deg);}
.ring-bg{fill:none;stroke:var(--border);stroke-width:9;}
.ring-fill{fill:none;stroke-width:9;stroke-linecap:round;transition:stroke-dasharray .8s ease;}
.ring-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;}
.ring-val{font-family:'Bebas Neue',sans-serif;font-size:22px;line-height:1;}
.ring-sub{font-size:10px;color:var(--muted);}

/* PROGRESS BAR */
.pbar{margin-bottom:10px;}
.pbar-hd{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:4px;}
.pbar-hd span:first-child{color:var(--text);font-weight:500;}
.pbar-track{background:var(--border);border-radius:99px;height:7px;overflow:hidden;}
.pbar-fill{height:100%;border-radius:99px;transition:width .6s ease;}

/* BUTTONS */
.btn{padding:9px 18px;border-radius:8px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;transition:all .2s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--accent);color:#000;}
.btn-primary:hover{background:#00ffb2;}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;}
.btn-ghost{background:var(--card2);border:1px solid var(--border);color:var(--text);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
.btn-sm{padding:5px 12px;font-size:12px;}
.btn-active{background:var(--accent)!important;color:#000!important;border-color:var(--accent)!important;}

/* FORM INPUTS */
.inp{width:100%;background:var(--card2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:9px 12px;font-family:'DM Sans',sans-serif;font-size:13px;outline:none;}
.inp:focus{border-color:var(--accent);}
.inp::placeholder{color:var(--muted);}
select.inp{cursor:pointer;}

/* WATER DROPS */
.drops{display:flex;gap:7px;flex-wrap:wrap;margin:8px 0;}
.drop{width:34px;height:42px;cursor:pointer;opacity:.25;transition:all .2s;font-size:24px;line-height:42px;text-align:center;filter:grayscale(1);}
.drop.on{opacity:1;filter:none;transform:scale(1.08);}
.drop.half{opacity:.6;filter:grayscale(.4);transform:scale(1.04);}

/* MOOD */
.mood-row{display:flex;gap:8px;margin:8px 0;}
.mood-btn{flex:1;padding:9px 6px;border-radius:10px;border:1px solid var(--border);background:var(--card2);cursor:pointer;text-align:center;font-size:20px;transition:all .2s;}
.mood-btn:hover,.mood-btn.on{border-color:var(--accent);background:rgba(0,229,160,0.09);}
.mood-lbl{font-size:10px;color:var(--muted);margin-top:3px;}

/* ENERGY SLIDER */
.energy-slider{-webkit-appearance:none;width:100%;height:7px;border-radius:99px;background:var(--border);outline:none;margin:12px 0;cursor:pointer;}
.energy-slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--yellow);border:3px solid var(--bg);cursor:pointer;box-shadow:0 0 8px rgba(255,212,96,.4);}

/* FOOD ITEMS */
.food-row{display:flex;align-items:center;justify-content:space-between;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;transition:all .2s;}
.food-row:hover{border-color:var(--accent);}
.food-name{font-weight:500;font-size:13px;}
.food-meta{font-size:11px;color:var(--muted);margin-top:1px;}
.badge{font-size:10px;font-weight:600;padding:2px 7px;border-radius:99px;}
.bp{background:rgba(77,168,255,.15);color:var(--accent3);}
.bc{background:rgba(255,212,96,.15);color:var(--yellow);}
.bf{background:rgba(0,229,160,.12);color:var(--accent);}

/* MEAL LOG ENTRIES */
.meal-entry{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--card2);border-radius:8px;margin-bottom:5px;}
.meal-entry-name{font-size:12px;font-weight:500;}
.meal-entry-meta{font-size:11px;color:var(--muted);}
.rm-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0 4px;transition:color .2s;flex-shrink:0;}
.rm-btn:hover{color:var(--danger);}

/* INSIGHT CARD */
.insight{background:linear-gradient(135deg,rgba(0,229,160,.07) 0%,rgba(77,168,255,.04) 100%);border:1px solid rgba(0,229,160,.18);border-radius:var(--radius);padding:14px;margin-bottom:10px;}
.insight-title{font-size:12px;font-weight:700;margin-bottom:3px;}
.insight-body{font-size:12px;line-height:1.7;color:var(--text);}
.insight-body strong{color:var(--accent);}

/* MODAL OVERLAY */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:500;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:26px;max-width:460px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.5);max-height:90vh;overflow-y:auto;}
.modal h2{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px;color:var(--accent);margin-bottom:4px;}
.modal-sub{font-size:12px;color:var(--muted);margin-bottom:18px;}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;float:right;margin-top:-4px;}

/* DROPDOWN PANEL (replaces expanding cards) */
.drop-panel{position:fixed;top:0;right:0;width:380px;height:100vh;background:var(--surface);border-left:1px solid var(--border);z-index:400;transform:translateX(100%);transition:transform .3s ease;overflow-y:auto;box-shadow:-10px 0 40px rgba(0,0,0,.4);}
.drop-panel.open{transform:translateX(0);}
.drop-panel-hd{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--surface);z-index:1;}
.drop-panel-hd h3{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1.5px;color:var(--accent);}
.drop-panel-body{padding:18px 20px;}
.drop-panel-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:20px;}

/* TOAST */
#toast{position:fixed;bottom:22px;right:22px;background:var(--accent);color:#000;padding:10px 18px;border-radius:8px;font-weight:600;font-size:13px;z-index:999;opacity:0;transform:translateY(8px);transition:all .3s;pointer-events:none;display:flex;align-items:center;gap:8px;}
#toast.show{opacity:1;transform:translateY(0);pointer-events:auto;}

/* BODY COMP GRID */
.bcomp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.bcomp-tile{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;}
.bcomp-val{font-family:'Bebas Neue',sans-serif;font-size:26px;}
.bcomp-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;}

/* LOG HISTORY */
.log-entry{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;}
.log-date{font-family:'DM Mono',monospace;font-size:11px;color:var(--accent);margin-bottom:6px;}
.log-chips{display:flex;gap:8px;flex-wrap:wrap;}
.log-chip{font-size:12px;color:var(--muted);}
.log-chip strong{color:var(--text);font-family:'DM Mono',monospace;}

/* TIMING */
.timing-row{display:flex;gap:10px;margin-bottom:12px;align-items:flex-start;}
.timing-dot{width:9px;height:9px;border-radius:50%;margin-top:4px;flex-shrink:0;box-shadow:0 0 7px currentColor;}
.timing-time{font-family:'DM Mono',monospace;font-size:11px;min-width:56px;padding-top:2px;}
.timing-card{flex:1;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;}
.timing-meal{font-weight:600;font-size:12px;margin-bottom:3px;}
.timing-desc{font-size:12px;color:var(--muted);line-height:1.5;}

/* COACH */
.coach-chips{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:12px;}
.coach-chip{background:var(--card2);border:1px solid var(--border);border-radius:20px;color:var(--muted);padding:6px 12px;font-size:12px;cursor:pointer;transition:all .2s;}
.coach-chip:hover{border-color:var(--accent);color:var(--accent);}
.coach-response{background:linear-gradient(135deg,rgba(0,229,160,.06) 0%,rgba(77,168,255,.04) 100%);border:1px solid rgba(0,229,160,.18);border-radius:10px;padding:14px;font-size:13px;line-height:1.75;display:none;margin-top:10px;}
.coach-response.show{display:block;}
.coach-loading{color:var(--muted);font-size:13px;margin-top:10px;display:none;}

/* CAMERA / SCAN */
#barcode-video{width:100%;border-radius:8px;max-height:220px;object-fit:cover;}
.scan-overlay{position:relative;border-radius:8px;overflow:hidden;background:#000;display:none;}
.scan-overlay.show{display:block;}
.scan-corners{position:absolute;inset:20px;border:2px solid var(--accent);border-radius:8px;pointer-events:none;box-shadow:0 0 0 9999px rgba(0,0,0,.45);}
.scan-status{text-align:center;font-size:12px;padding:8px;color:var(--muted);}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}

/* RESPONSIVE */
@media(max-width:900px){.g3,.g4{grid-template-columns:1fr 1fr;}.span3{grid-column:span 2;}}
@media(max-width:600px){
  .g2,.g3,.g4{grid-template-columns:1fr;}
  .span2,.span3{grid-column:span 1;}
  .drop-panel{width:100%;left:0!important;right:0!important;}
  .header-goals{display:none;}
  .panel{padding:12px;padding-bottom:90px;} /* room for FAB */
  .tabs{padding:0 8px;}
  .tab{padding:11px 12px;font-size:12px;}
  header{padding:10px 14px;}
  .logo{font-size:20px;}
  .card{padding:14px;}
  .stat-val{font-size:28px;}
  /* Simple mode compact stats */
  .simple-stat-row{grid-template-columns:1fr 1fr!important;}
}

/* ‚îÄ‚îÄ FAB (Floating Action Button) ‚îÄ‚îÄ */
#fab{
  position:fixed;bottom:22px;right:20px;z-index:400;
  width:58px;height:58px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent),#00c87a);
  border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:26px;line-height:1;
  box-shadow:0 4px 24px rgba(0,229,160,.45);
  transition:transform .2s, box-shadow .2s;
}
#fab:hover{transform:scale(1.08);box-shadow:0 6px 32px rgba(0,229,160,.6);}
#fab:active{transform:scale(0.95);}
#fab.open{background:linear-gradient(135deg,#ff4560,#cc2244);transform:rotate(45deg);}

/* ‚îÄ‚îÄ BOTTOM SHEET ‚îÄ‚îÄ */
#quick-sheet{
  position:fixed;inset:0;z-index:390;
  pointer-events:none;
}
#quick-sheet.show{pointer-events:all;}
#quick-sheet-backdrop{
  position:absolute;inset:0;background:rgba(0,0,0,.55);
  opacity:0;transition:opacity .25s;
}
#quick-sheet.show #quick-sheet-backdrop{opacity:1;}
#quick-sheet-panel{
  position:absolute;left:0;right:0;bottom:0;
  background:var(--surface);
  border-top:1px solid var(--border);
  border-radius:18px 18px 0 0;
  padding:0 0 env(safe-area-inset-bottom,0);
  transform:translateY(100%);
  transition:transform .3s cubic-bezier(.32,.72,0,1);
  max-height:82vh;
  display:flex;flex-direction:column;
}
#quick-sheet.show #quick-sheet-panel{transform:translateY(0);}
.sheet-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:10px auto 14px;}
.sheet-header{padding:0 16px 10px;display:flex;justify-content:space-between;align-items:center;}
.sheet-title{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1.5px;color:var(--accent);}
.sheet-body{overflow-y:auto;padding:0 14px 16px;flex:1;}

/* Quick-add chips row */
.quick-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
.quick-chip{
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:8px 12px;cursor:pointer;
  font-size:12px;font-weight:500;
  display:flex;flex-direction:column;gap:2px;
  transition:all .15s;min-width:80px;text-align:center;
}
.quick-chip:hover,.quick-chip:active{border-color:var(--accent);background:rgba(0,229,160,.07);}
.quick-chip-name{font-size:12px;font-weight:600;}
.quick-chip-p{font-size:11px;color:var(--accent3);font-family:'DM Mono',monospace;}

/* ‚îÄ‚îÄ SIMPLE MODE ‚îÄ‚îÄ */
body.simple-mode #tab-today .macro-rings-card,
body.simple-mode #tab-today .mood-card,
body.simple-mode #tab-today .coach-card,
body.simple-mode #dynamic-insights{display:none!important;}

/* Simple today summary bar */
#simple-today{display:none;margin-bottom:14px;}
body.simple-mode #simple-today{display:block;}
body.simple-mode #full-today-extra{display:none;}

.progress-bar-row{margin-bottom:10px;}
.pb-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:5px;}
.pb-label span:first-child{font-weight:600;color:var(--text);}
.pb-track{height:10px;background:var(--border);border-radius:99px;overflow:hidden;}
.pb-fill{height:100%;border-radius:99px;transition:width .5s ease;}

/* Simple insight pill */
.simple-insight{padding:12px 14px;border-radius:10px;font-size:13px;line-height:1.6;margin-bottom:10px;}

/* Water buttons large (mobile) */
.water-btn-row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
.water-btn-lg{flex:1;min-width:70px;padding:12px 8px;font-size:13px;font-weight:700;border-radius:10px;text-align:center;}

/* Section label */
.sec-label{font-size:11px;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);margin-bottom:10px;}
hr.divider{border:none;border-top:1px solid var(--border);margin:14px 0;}

/* Muscle group toggles */
.muscle-btn{padding:5px 10px;font-size:11px;border-radius:6px;}

/* Goals profile buttons */
.goals-btn{display:flex;align-items:center;gap:12px;padding:10px 14px;text-align:left;width:100%;justify-content:flex-start;border-radius:10px;transition:all .2s;}
.goals-btn.selected{background:rgba(0,229,160,.1);border-color:rgba(0,229,160,.35);color:var(--text);}
.goals-btn.selected-multi{background:rgba(77,168,255,.1);border-color:rgba(77,168,255,.35);color:var(--text);}
.goal-chip-dynamic{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:0.6px;text-transform:uppercase;white-space:nowrap;}
</style>
</head>
<body>

<!-- FAB -->
<button id="fab" onclick="toggleQuickSheet()" title="Quick Add Food">Ôºã</button>

<!-- QUICK ADD BOTTOM SHEET -->
<div id="quick-sheet">
  <div id="quick-sheet-backdrop" onclick="closeQuickSheet()"></div>
  <div id="quick-sheet-panel">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title">Quick Add</span>
      <div style="display:flex;gap:8px;align-items:center;">
        <select id="sheet-meal-target" class="inp" style="padding:5px 10px;font-size:12px;min-width:130px;">
          <option>Breakfast</option><option>Morning Snack</option><option>Lunch</option>
          <option>Afternoon Snack</option><option>Dinner</option><option>Evening Snack</option>
        </select>
        <button onclick="closeQuickSheet()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1;">‚úï</button>
      </div>
    </div>
    <div class="sheet-body">
      <!-- Frequent foods chips -->
      <div class="sec-label">Your Foods ‚Äî Tap to Add</div>
      <div class="quick-chips" id="sheet-food-chips"></div>
      <!-- Search within sheet -->
      <div class="sec-label">Search</div>
      <input type="text" class="inp" id="sheet-search" placeholder="üîç Search foods..." oninput="filterSheetFoods()" style="margin-bottom:10px;">
      <div id="sheet-food-list" style="display:flex;flex-direction:column;gap:6px;"></div>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">Fuel<span>Strong</span></div>
  <div class="header-goals">
    <span class="goal-chip chip-muscle">üí™ Build Muscle</span>
    <span class="goal-chip chip-fat">üî• Lose Fat</span>
  </div>
  <div class="header-right">
    <button onclick="handleDriveAuth()" id="drive-btn" class="btn btn-ghost btn-sm">‚òÅÔ∏è <span id="drive-label">Connect Drive</span></button>
    <span class="date-chip" id="header-date">‚Äî</span>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('today',this)">üìä Today</div>
  <div class="tab" onclick="switchTab('food',this)">ü•ó Food Log</div>
  <div class="tab" onclick="switchTab('timing',this)">‚è± Timing</div>
  <div class="tab" onclick="switchTab('body',this)">üìÇ Body & Training</div>
  <div class="tab" onclick="switchTab('history',this)">üìÖ History</div>
  <div class="tab" onclick="switchTab('settings',this)">‚öôÔ∏è Settings</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TODAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-today" class="panel active">

  <!-- ‚îÄ‚îÄ SIMPLE MODE VIEW ‚îÄ‚îÄ -->
  <div id="simple-today">
    <!-- Big status numbers -->
    <div class="g2 simple-stat-row" style="margin-bottom:12px;">
      <div class="stat-tile" style="text-align:center;padding:18px 12px;">
        <div class="stat-label">Protein</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:52px;line-height:1;color:var(--accent3);" id="s-protein">0</div>
        <div style="font-size:12px;color:var(--muted);">/ <strong id="s-protein-goal">150</strong>g</div>
        <div class="pb-track" style="margin-top:8px;"><div class="pb-fill" id="s-protein-bar" style="background:var(--accent3);width:0%;"></div></div>
      </div>
      <div class="stat-tile" style="text-align:center;padding:18px 12px;">
        <div class="stat-label">Calories</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:52px;line-height:1;color:var(--yellow);" id="s-cal">0</div>
        <div style="font-size:12px;color:var(--muted);">/ <strong id="s-cal-goal">1800</strong> kcal</div>
        <div class="pb-track" style="margin-top:8px;"><div class="pb-fill" id="s-cal-bar" style="background:var(--yellow);width:0%;"></div></div>
      </div>
    </div>

    <!-- Water row (simple) -->
    <div class="card" style="margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <span class="card-title">üíß Water</span>
        <span style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--accent3);" id="s-water">0</span>
        <span style="font-size:12px;color:var(--muted);">/ 80 oz</span>
      </div>
      <div class="pb-track" style="height:8px;margin-bottom:10px;"><div class="pb-fill" id="s-water-bar" style="background:var(--accent3);width:0%;"></div></div>
      <div class="water-btn-row">
        <button class="btn btn-primary water-btn-lg" onclick="addWater(8);updateSimpleMode()">+8 oz</button>
        <button class="btn btn-primary water-btn-lg" onclick="addWater(16);updateSimpleMode()">+16 oz</button>
        <button class="btn btn-ghost water-btn-lg" onclick="addWater(20);updateSimpleMode()">+20 oz</button>
        <button class="btn btn-ghost water-btn-lg" onclick="addWater(-8);updateSimpleMode()">‚àí8 oz</button>
      </div>
    </div>

    <!-- Single smart insight (simple) -->
    <div id="simple-insight-card" class="card" style="margin-bottom:12px;"></div>

    <!-- Today's logged meals (compact) -->
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><span class="card-title">üìù Today's Meals</span>
        <button class="btn btn-ghost btn-sm" onclick="switchTab('food',document.querySelector('[onclick*=\"food\"]'))">+ Add ‚Üí</button>
      </div>
      <div id="simple-meal-summary"></div>
    </div>

    <!-- Day plan (simple) -->
    <div class="card">
      <div class="card-hd"><span class="card-title">üéØ Day Plan</span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="simple-day-plan-btns">
        <button class="btn btn-ghost btn-sm day-plan-btn" data-plan="workout" onclick="toggleDayPlan('workout',this);updateSimpleMode()">üí™ Training</button>
        <button class="btn btn-ghost btn-sm day-plan-btn" data-plan="recover" onclick="toggleDayPlan('recover',this);updateSimpleMode()">üò¥ Recovery</button>
        <button class="btn btn-ghost btn-sm day-plan-btn" data-plan="light" onclick="toggleDayPlan('light',this);updateSimpleMode()">üö∂ Light</button>
        <button class="btn btn-ghost btn-sm day-plan-btn simple-injection-btn" data-plan="injection" onclick="toggleDayPlan('injection',this);updateSimpleMode()" style="display:none;">üíâ Injection</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ FULL MODE VIEW ‚îÄ‚îÄ -->
  <div id="full-today-extra">
  <!-- TOP STATS -->
  <div class="g4" style="margin-bottom:14px;">
    <div class="stat-tile" style="cursor:pointer;" onclick="openPanel('panel-protein')">
      <div class="stat-label">Protein <span style="font-size:9px;color:var(--muted);">‚ñº tap</span></div>
      <div><span class="stat-val" id="tot-protein" style="color:var(--accent3)">0</span><span class="stat-unit">g</span></div>
      <div class="stat-sub">Goal: <strong id="goal-protein-disp">150</strong>g</div>
    </div>
    <div class="stat-tile">
      <div class="stat-label">Calories</div>
      <div><span class="stat-val" id="tot-cal" style="color:var(--yellow)">0</span><span class="stat-unit">kcal</span></div>
      <div class="stat-sub">Goal: <strong id="goal-cal-disp">1800</strong> kcal</div>
    </div>
    <div class="stat-tile">
      <div class="stat-label">Water</div>
      <div><span class="stat-val" id="tot-water" style="color:var(--accent3)">0</span><span class="stat-unit">oz</span></div>
      <div class="stat-sub">Goal: 80 oz</div>
    </div>
    <div class="stat-tile">
      <div class="stat-label">Energy</div>
      <div><span class="stat-val" id="tot-energy" style="color:var(--yellow)">‚Äî</span></div>
      <div class="stat-sub" id="energy-stat-sub">Not logged</div>
    </div>
  </div>

  <div class="g3" style="margin-bottom:14px;">
    <!-- MACRO RINGS -->
    <div class="card">
      <div class="card-hd"><span class="card-title">Macro Rings</span></div>
      <div style="display:flex;justify-content:space-around;">
        <div style="text-align:center;">
          <div class="ring-wrap">
            <svg class="ring-svg" viewBox="0 0 100 100"><circle class="ring-bg" cx="50" cy="50" r="43"/><circle class="ring-fill" id="ring-p" cx="50" cy="50" r="43" stroke="var(--accent3)" stroke-dasharray="0 270"/></svg>
            <div class="ring-center"><div class="ring-val" id="ring-p-val" style="color:var(--accent3)">0%</div><div class="ring-sub">Protein</div></div>
          </div>
        </div>
        <div style="text-align:center;">
          <div class="ring-wrap">
            <svg class="ring-svg" viewBox="0 0 100 100"><circle class="ring-bg" cx="50" cy="50" r="43"/><circle class="ring-fill" id="ring-c" cx="50" cy="50" r="43" stroke="var(--yellow)" stroke-dasharray="0 270"/></svg>
            <div class="ring-center"><div class="ring-val" id="ring-c-val" style="color:var(--yellow)">0%</div><div class="ring-sub">Calories</div></div>
          </div>
        </div>
        <div style="text-align:center;">
          <div class="ring-wrap">
            <svg class="ring-svg" viewBox="0 0 100 100"><circle class="ring-bg" cx="50" cy="50" r="43"/><circle class="ring-fill" id="ring-w" cx="50" cy="50" r="43" stroke="var(--accent3)" stroke-dasharray="0 270"/></svg>
            <div class="ring-center"><div class="ring-val" id="ring-w-val" style="color:var(--accent3)">0%</div><div class="ring-sub">Water</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- WATER + ENERGY -->
    <div class="card">
      <div class="card-hd"><span class="card-title">üíß Water</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-primary btn-sm" onclick="addWater(20)">+20</button>
          <button class="btn btn-ghost btn-sm" onclick="addWater(8)">+8</button>
          <button class="btn btn-ghost btn-sm" onclick="addWater(-8)">‚àí8</button>
        </div>
      </div>
      <div class="drops" id="water-drops"></div>
      <div style="font-size:12px;color:var(--muted);" id="water-count">0 / 80 oz</div>
      <hr class="divider">
      <div class="card-title" style="margin-bottom:10px;">‚ö° Energy</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:44px;color:var(--yellow);text-align:center;line-height:1;" id="energy-display">‚Äî</div>
      <div style="text-align:center;font-size:12px;color:var(--muted);margin-top:2px;" id="energy-label">Slide to log</div>
      <input type="range" class="energy-slider" id="energy-slider" min="1" max="10" value="5" oninput="updateEnergy(this.value)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-top:-6px;"><span>üò¥</span><span>üöÄ</span></div>
    </div>

    <!-- MOOD + NOTES -->
    <div class="card">
      <div class="card-hd"><span class="card-title">üòä Mood</span></div>
      <div class="mood-row" id="mood-row"></div>
      <textarea class="inp" id="mood-notes" rows="4" placeholder="Hunger levels? Side effects? Sleep? Energy? Anything notable today..." style="resize:vertical;margin-top:10px;line-height:1.6;font-size:13px;"></textarea>
      <button class="btn btn-primary btn-sm" style="margin-top:8px;" onclick="saveMoodNote()">Save Note</button>
    </div>
  </div>

  <!-- DAY PLAN + INSIGHTS -->
  <div class="g2">
    <div class="card">
      <div class="card-hd"><span class="card-title">üéØ Day Plan</span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;" id="day-plan-btns">
        <button class="btn btn-ghost btn-sm day-plan-btn" data-plan="workout" onclick="toggleDayPlan('workout',this)">üí™ Training</button>
        <button class="btn btn-ghost btn-sm day-plan-btn" data-plan="recover" onclick="toggleDayPlan('recover',this)">üò¥ Recovery</button>
        <button class="btn btn-ghost btn-sm day-plan-btn" data-plan="light" onclick="toggleDayPlan('light',this)">üö∂ Light</button>
        <button class="btn btn-ghost btn-sm day-plan-btn" data-plan="injection" onclick="toggleDayPlan('injection',this)">üíâ Injection</button>
      </div>
      <div id="workout-time-row" style="display:none;padding:10px;background:rgba(77,168,255,.06);border:1px solid rgba(77,168,255,.18);border-radius:8px;margin-bottom:12px;">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span style="font-size:12px;color:var(--accent3);font-weight:600;">üèãÔ∏è Workout time</span>
          <input type="time" id="workout-time" class="inp" style="width:auto;padding:4px 10px;font-family:'DM Mono',monospace;" onchange="saveWorkoutTime()">
        </div>
        <div id="workout-time-status" style="font-size:11px;color:var(--muted);margin-top:6px;"></div>
      </div>
      <!-- Today's quick meal log summary -->
      <div class="sec-label">Today's Meals</div>
      <div id="today-meal-summary" style="font-size:13px;color:var(--muted);">No meals logged yet.</div>
    </div>

    <!-- AI COACH -->
    <div class="card">
      <div class="card-hd">
        <span class="card-title">üß† AI Coach</span>
        <button class="btn btn-ghost btn-sm" onclick="clearCoach()">Clear</button>
      </div>
      <div class="coach-chips" id="coach-chips"></div>
      <div style="display:flex;gap:8px;">
        <input type="text" class="inp" id="coach-input" placeholder="Ask anything..." onkeydown="if(event.key==='Enter')askCoach()" style="flex:1;">
        <button class="btn btn-primary btn-sm" onclick="askCoach()">Ask</button>
      </div>
      <div class="coach-loading" id="coach-loading">‚öôÔ∏è Thinking about your day...</div>
      <div class="coach-response" id="coach-response"></div>
    </div>
  </div>

  <!-- DYNAMIC INSIGHTS (full width) -->
  <div id="dynamic-insights" style="margin-top:14px;"></div>
</div>

  </div><!-- /full-today-extra -->
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FOOD LOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-food" class="panel">
  <div class="g2">
    <!-- FOOD PICKER -->
    <div class="card">
      <div class="card-hd">
        <span class="card-title">ü•ó Foods</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-ghost btn-sm" onclick="openPanel('panel-custom-food')">+ Custom</button>
          <button class="btn btn-ghost btn-sm" onclick="openPanel('panel-saved-foods')" id="saved-foods-btn" style="display:none;">‚≠ê <span id="saved-count">0</span></button>
        </div>
      </div>
      <input type="text" class="inp" id="food-search" placeholder="üîç Search foods..." oninput="filterFoods()" style="margin-bottom:10px;">
      <div id="food-list" style="display:flex;flex-direction:column;gap:6px;max-height:480px;overflow-y:auto;"></div>
    </div>

    <!-- MEAL LOG -->
    <div class="card">
      <div class="card-hd"><span class="card-title">üìù Meal Log</span></div>
      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
        <select id="meal-target" class="inp" style="flex:1;min-width:140px;">
          <option>Breakfast</option>
          <option>Morning Snack</option>
          <option>Lunch</option>
          <option>Afternoon Snack</option>
          <option>Dinner</option>
          <option>Evening Snack</option>
        </select>
        <input type="time" id="meal-time" class="inp" style="width:auto;padding:6px 10px;font-family:'DM Mono',monospace;">
      </div>
      <div id="meal-log-container" style="max-height:400px;overflow-y:auto;"></div>
      <hr class="divider">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:2px;">
        <div style="text-align:center;padding:8px;background:var(--card2);border-radius:8px;">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--accent3)" id="sum-protein">0g</div>
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;">Protein</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--card2);border-radius:8px;">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--yellow)" id="sum-cal">0</div>
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;">Calories</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--card2);border-radius:8px;">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--accent)" id="sum-fiber">0g</div>
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;">Fiber</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-timing" class="panel">
  <div class="g2">
    <div class="card">
      <div class="card-hd"><span class="card-title">‚è± Optimal Meal Timing</span></div>
      <div class="insight" style="margin-bottom:14px;">
        <div class="insight-body">Eat protein every <strong>3‚Äì4 hours</strong> to max muscle protein synthesis. Tirzepatide reduces appetite ‚Äî use small, protein-dense meals to stay on track.</div>
      </div>
      <div id="timing-list"></div>
    </div>
    <div>
      <div class="card" style="margin-bottom:14px;">
        <div class="card-hd"><span class="card-title">ü•ó High-Protein Meal Combos</span></div>
        <div id="meal-combos"></div>
      </div>
      <div class="card">
        <div class="card-hd"><span class="card-title">üí° Tirzepatide Rules</span></div>
        <div style="display:flex;flex-direction:column;gap:9px;font-size:12px;line-height:1.6;">
          <div style="display:flex;gap:8px;"><span style="color:var(--accent);">‚úì</span><div><strong>Prioritize protein even when not hungry.</strong> Oikos Pro drink = 23g, no effort.</div></div>
          <div style="display:flex;gap:8px;"><span style="color:var(--accent);">‚úì</span><div><strong>4‚Äì5 small protein meals</strong> beats 1‚Äì2 large ones for muscle retention.</div></div>
          <div style="display:flex;gap:8px;"><span style="color:var(--accent);">‚úì</span><div><strong>Eat within 30‚Äì60 min after training.</strong> Non-negotiable for muscle building.</div></div>
          <div style="display:flex;gap:8px;"><span style="color:var(--accent);">‚úì</span><div><strong>Stay 300‚Äì500 kcal below maintenance</strong> ‚Äî too aggressive = muscle loss.</div></div>
          <div style="display:flex;gap:8px;"><span style="color:var(--accent);">‚úì</span><div><strong>Hydrate extra on injection days.</strong> Extra water helps GI effects.</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BODY & TRAINING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-body" class="panel">
  <!-- TRAINING CHECK-IN -->
  <div class="card" style="margin-bottom:14px;">
    <div class="card-hd"><span class="card-title">üèãÔ∏è Today's Training</span><button class="btn btn-primary btn-sm" onclick="saveTraining()">Save</button></div>
    <div class="g3">
      <div>
        <div class="sec-label">Did You Train?</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-ghost" id="train-yes" onclick="setTrained('yes')" style="flex:1;">üí™ Yes</button>
          <button class="btn btn-ghost" id="train-rest" onclick="setTrained('rest')" style="flex:1;">üò¥ Rest</button>
        </div>
      </div>
      <div>
        <div class="sec-label">Muscle Groups</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px;" id="muscle-btns">
          <button class="btn btn-ghost muscle-btn" onclick="toggleMuscle(this)" data-g="Chest">Chest</button>
          <button class="btn btn-ghost muscle-btn" onclick="toggleMuscle(this)" data-g="Back">Back</button>
          <button class="btn btn-ghost muscle-btn" onclick="toggleMuscle(this)" data-g="Legs">Legs</button>
          <button class="btn btn-ghost muscle-btn" onclick="toggleMuscle(this)" data-g="Shoulders">Shoulders</button>
          <button class="btn btn-ghost muscle-btn" onclick="toggleMuscle(this)" data-g="Arms">Arms</button>
          <button class="btn btn-ghost muscle-btn" onclick="toggleMuscle(this)" data-g="Core">Core</button>
          <button class="btn btn-ghost muscle-btn" onclick="toggleMuscle(this)" data-g="Full Body">Full Body</button>
        </div>
      </div>
      <div>
        <div class="sec-label">Post-Workout Protein (within 60 min)?</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-ghost btn-sm" id="pp-yes" onclick="setPostProtein('yes')" style="flex:1;">‚úÖ Yes</button>
          <button class="btn btn-ghost btn-sm" id="pp-no" onclick="setPostProtein('no')" style="flex:1;">‚ùå No</button>
          <button class="btn btn-ghost btn-sm" id="pp-na" onclick="setPostProtein('na')" style="flex:1;">‚Äî N/A</button>
        </div>
      </div>
    </div>
    <div id="training-insight" style="display:none;margin-top:14px;" class="insight"></div>
  </div>

  <!-- EVOLT ENTRY -->
  <div class="card" style="margin-bottom:14px;">
    <div class="card-hd">
      <span class="card-title">üìù Evolt Body Scan</span>
      <button class="btn btn-primary btn-sm" onclick="saveEvolt()">Save Scan</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px;" class="evolt-grid">
      <div>
        <div class="sec-label">Weight (lbs)</div>
        <input class="inp" id="ev-wt" type="number" step="0.1" placeholder="185">
      </div>
      <div>
        <div class="sec-label">Body Fat %</div>
        <input class="inp" id="ev-bf" type="number" step="0.1" placeholder="28.5">
      </div>
      <div>
        <div class="sec-label">Muscle Mass (lbs)</div>
        <input class="inp" id="ev-mm" type="number" step="0.1" placeholder="120">
      </div>
      <div>
        <div class="sec-label">Lean Mass (lbs)</div>
        <input class="inp" id="ev-lm" type="number" step="0.1" placeholder="132">
      </div>
      <div>
        <div class="sec-label">BMR (kcal)</div>
        <input class="inp" id="ev-bmr" type="number" placeholder="1650">
      </div>
      <div>
        <div class="sec-label">Visceral Fat (lbs)</div>
        <input class="inp" id="ev-vf" type="number" step="0.1" placeholder="4.2">
      </div>
      <div>
        <div class="sec-label">Total Body Water (lbs)</div>
        <input class="inp" id="ev-hyd" type="number" step="0.1" placeholder="98.5">
      </div>
      <div>
        <div class="sec-label">Total Fat Mass (lbs)</div>
        <input class="inp" id="ev-fm" type="number" step="0.1" placeholder="53.0">
      </div>
      <div>
        <div class="sec-label">Scan Date</div>
        <input class="inp" id="ev-date" type="date">
      </div>
    </div>
    <!-- Goal calc preview -->
    <div id="goal-preview" style="display:none;padding:12px;background:rgba(0,229,160,.06);border:1px solid rgba(0,229,160,.18);border-radius:8px;font-size:12px;line-height:1.8;">
    </div>
  </div>

  <!-- EVOLT HISTORY -->
  <div class="card" id="evolt-history-card" style="display:none;">
    <div class="card-hd"><span class="card-title">üìà Body Comp History</span></div>
    <div id="evolt-history-list" style="display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto;"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-history" class="panel">
  <div class="card" style="margin-bottom:14px;">
    <div class="card-hd"><span class="card-title">üìÖ Daily Log History</span>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary" onclick="showCompleteDayModal()">üèÅ Complete Day</button>
        <button class="btn btn-ghost btn-sm" onclick="exportData()">üì§ Export</button>
        <label class="btn btn-ghost btn-sm" style="cursor:pointer;">üì• Import<input type="file" accept=".json" onchange="importData(event)" style="display:none;"></label>
      </div>
    </div>
    <div id="history-list">
      <div style="color:var(--muted);font-size:13px;text-align:center;padding:40px;">Complete your first day to start tracking history!</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-settings" class="panel">
  <div class="g2">
    <!-- GOOGLE DRIVE -->
    <div class="card">
      <div class="card-hd"><span class="card-title">‚òÅÔ∏è Google Drive Sync</span><span id="drive-badge" style="font-size:11px;padding:3px 10px;border-radius:99px;background:var(--card2);color:var(--muted);">Not connected</span></div>
      <div id="drive-setup">
        <div style="font-size:13px;color:var(--muted);margin-bottom:12px;line-height:1.6;">Sync to a <strong style="color:var(--text);">FuelStrong</strong> folder on Google Drive. Auto-syncs between devices.</div>
        <div class="sec-label">Google Client ID</div>
        <input id="gapi-client-id" class="inp" placeholder="xxxxx.apps.googleusercontent.com" style="margin-bottom:10px;font-family:'DM Mono',monospace;font-size:12px;" oninput="saveDriveCreds()">
        <button class="btn btn-primary" onclick="handleDriveAuth()">‚òÅÔ∏è Connect Google Drive</button>
      </div>
      <div id="drive-connected" style="display:none;">
        <div style="font-size:13px;color:var(--text);margin-bottom:6px;" id="drive-account">Connected</div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:14px;" id="drive-last-sync">Never synced</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-primary btn-sm" onclick="syncToDrive()">üîÑ Sync Now</button>
          <button class="btn btn-ghost btn-sm" onclick="loadFromDrive()">üì• Load from Drive</button>
          <button class="btn btn-ghost btn-sm" onclick="disconnectDrive()">Disconnect</button>
        </div>
      </div>
    </div>

    <!-- API KEY + PROXY -->
    <div class="card">
      <div class="card-hd"><span class="card-title">ü§ñ AI Settings</span></div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:14px;line-height:1.6;">
        AI features (label scanning, macro estimation, coach) require both fields below.
        Get your API key at <strong style="color:var(--accent3);">console.anthropic.com</strong>
      </div>

      <div class="sec-label">Anthropic API Key</div>
      <div style="position:relative;margin-bottom:4px;">
        <input id="anthropic-key" class="inp" type="password" placeholder="sk-ant-..." style="font-family:'DM Mono',monospace;font-size:12px;padding-right:36px;" oninput="saveApiKey()">
        <button onclick="toggleKeyVis()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;" id="key-eye">üëÅ</button>
      </div>
      <div id="key-status" style="font-size:11px;min-height:16px;margin-bottom:14px;"></div>

      <div class="sec-label">Cloudflare Worker Proxy URL</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">Deploy the worker file from GitHub, then paste its URL here (e.g. https://fuelstrong.yourname.workers.dev)</div>
      <input id="proxy-url" class="inp" type="url" placeholder="https://fuelstrong.yourname.workers.dev" style="font-family:'DM Mono',monospace;font-size:12px;margin-bottom:4px;" oninput="saveProxyUrl()">
      <div id="proxy-status" style="font-size:11px;min-height:16px;"></div>
    </div>

    <!-- GOALS PROFILE ‚Äî full card spanning 2 columns -->
    <div class="card" style="grid-column:span 2;">
      <div class="card-hd">
        <span class="card-title">üéØ Goals Profile</span>
        <span id="goals-profile-badge" style="font-size:11px;padding:3px 10px;border-radius:99px;background:rgba(0,229,160,.1);color:var(--accent);display:none;">‚úì Profile set</span>
      </div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:16px;line-height:1.6;">
        Tell FuelStrong about your goals ‚Äî all AI insights, coaching tips, and nutrition guidance will adapt to match your situation.
      </div>

      <div class="g2" style="gap:20px;">
        <!-- LEFT COLUMN -->
        <div>
          <!-- PRIMARY GOAL -->
          <div class="sec-label" style="margin-bottom:8px;">Primary Goal</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px;" id="primary-goal-btns">
            <button class="btn btn-ghost goals-btn" data-goal-type="primary" data-goal="recomp" onclick="selectGoal('primary','recomp',this)">
              <span style="font-size:16px;">‚öñÔ∏è</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Body Recomposition</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Build muscle while losing fat simultaneously</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn" data-goal-type="primary" data-goal="muscle" onclick="selectGoal('primary','muscle',this)">
              <span style="font-size:16px;">üí™</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Build Muscle (Primary)</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Prioritize muscle gain, accept some fat gain</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn" data-goal-type="primary" data-goal="fat_loss" onclick="selectGoal('primary','fat_loss',this)">
              <span style="font-size:16px;">üî•</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Fat Loss (Primary)</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Prioritize fat loss while preserving muscle</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn" data-goal-type="primary" data-goal="maintain" onclick="selectGoal('primary','maintain',this)">
              <span style="font-size:16px;">üéØ</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Maintain</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Hold current composition, build healthy habits</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn" data-goal-type="primary" data-goal="track" onclick="selectGoal('primary','track',this)">
              <span style="font-size:16px;">üìä</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Just Track</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Log food and health data, no specific goal</div>
              </div>
            </button>
          </div>

          <!-- ACTIVITY LEVEL -->
          <div class="sec-label" style="margin-bottom:8px;">Activity Level</div>
          <div style="display:flex;flex-direction:column;gap:6px;" id="activity-btns">
            <button class="btn btn-ghost goals-btn" data-goal-type="activity" data-goal="sedentary" onclick="selectGoal('activity','sedentary',this)">
              <span style="font-size:16px;">üõãÔ∏è</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Sedentary</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Desk job, minimal movement (√ó1.2 BMR)</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn" data-goal-type="activity" data-goal="light" onclick="selectGoal('activity','light',this)">
              <span style="font-size:16px;">üö∂</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Lightly Active</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Light exercise 1‚Äì3 days/week (√ó1.375 BMR)</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn" data-goal-type="activity" data-goal="moderate" onclick="selectGoal('activity','moderate',this)">
              <span style="font-size:16px;">üèÉ</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Moderately Active</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Moderate exercise 3‚Äì5 days/week (√ó1.55 BMR)</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn" data-goal-type="activity" data-goal="very_active" onclick="selectGoal('activity','very_active',this)">
              <span style="font-size:16px;">üî•</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Very Active</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Hard exercise 6‚Äì7 days/week (√ó1.725 BMR)</div>
              </div>
            </button>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div>
          <!-- MEDICAL / CONTEXT FLAGS -->
          <div class="sec-label" style="margin-bottom:8px;">Context & Medical Flags <span style="font-size:10px;color:var(--muted);font-weight:400;">(select all that apply)</span></div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px;" id="context-flag-btns">
            <button class="btn btn-ghost goals-btn goals-multi" data-flag="glp1" onclick="toggleContextFlag('glp1',this)">
              <span style="font-size:16px;">üíâ</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">On GLP-1 Medication</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Tirzepatide, semaglutide, etc. ‚Äî enables injection day coaching</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn goals-multi" data-flag="resistance" onclick="toggleContextFlag('resistance',this)">
              <span style="font-size:16px;">üèãÔ∏è</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Resistance Training</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Regular weightlifting ‚Äî enables workout timing insights</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn goals-multi" data-flag="evolt" onclick="toggleContextFlag('evolt',this)">
              <span style="font-size:16px;">üìä</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Using Evolt Body Scanner</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Regular body comp scans to track progress</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn goals-multi" data-flag="appetite_issues" onclick="toggleContextFlag('appetite_issues',this)">
              <span style="font-size:16px;">üçΩÔ∏è</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Low Appetite / Nausea</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Struggling to eat enough ‚Äî enables soft-food nudges</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn goals-multi" data-flag="high_protein" onclick="toggleContextFlag('high_protein',this)">
              <span style="font-size:16px;">ü•©</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Prioritize High Protein</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">More aggressive protein targets (1g per lb)</div>
              </div>
            </button>
          </div>

          <!-- APP MODE -->
          <div class="sec-label" style="margin-bottom:8px;">App Mode</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px;" id="mode-btns">
            <button class="btn btn-ghost goals-btn" data-goal-type="mode" data-goal="full" onclick="selectGoal('mode','full',this)">
              <span style="font-size:16px;">‚öôÔ∏è</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Full Mode</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">All features: Evolt, timing, detailed insights, coach</div>
              </div>
            </button>
            <button class="btn btn-ghost goals-btn" data-goal-type="mode" data-goal="simple" onclick="selectGoal('mode','simple',this)">
              <span style="font-size:16px;">‚ö°</span>
              <div style="text-align:left;">
                <div style="font-weight:600;">Simple Mode</div>
                <div style="font-size:11px;color:var(--muted);font-weight:400;">Quick log, status bar, light coaching ‚Äî less clutter</div>
              </div>
            </button>
          </div>

          <!-- PROTEIN MULTIPLIER PREVIEW -->
          <div id="protein-multiplier-preview" style="display:none;padding:12px;background:rgba(0,229,160,.06);border:1px solid rgba(0,229,160,.18);border-radius:8px;font-size:12px;line-height:1.8;margin-bottom:16px;"></div>

          <!-- SAVE BUTTON -->
          <button class="btn btn-primary" style="width:100%;" onclick="saveGoalsProfile()">‚úÖ Save Goals Profile</button>
          <div id="goals-profile-status" style="font-size:11px;color:var(--muted);margin-top:6px;text-align:center;"></div>
        </div>
      </div>
    </div>

    <!-- GOALS (manual override) -->
    <div class="card">
      <div class="card-hd"><span class="card-title">üìê Numeric Goals</span></div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:12px;">Auto-calculated from your Goals Profile + Evolt scan. Override manually if needed.</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
        <div>
          <div class="sec-label">Protein Goal (g)</div>
          <input class="inp" id="goal-protein-input" type="number" placeholder="150" oninput="saveGoals()">
        </div>
        <div>
          <div class="sec-label">Calorie Goal (kcal)</div>
          <input class="inp" id="goal-cal-input" type="number" placeholder="1800" oninput="saveGoals()">
        </div>
      </div>
      <div id="goals-source" style="font-size:11px;color:var(--muted);"></div>
    </div>

    <!-- DATA MANAGEMENT -->
    <div class="card">
      <div class="card-hd"><span class="card-title">üóÇ Data Management</span></div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button class="btn btn-ghost" onclick="exportData()">üì§ Export All Data (JSON)</button>
        <label class="btn btn-ghost" style="cursor:pointer;justify-content:center;">üì• Import JSON Backup<input type="file" accept=".json" onchange="importData(event)" style="display:none;"></label>
        <button class="btn btn-ghost" style="color:var(--danger);border-color:var(--danger);" onclick="confirmClearAll()">üóë Clear All Data</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SLIDE-OUT PANELS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="panel-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:390;" onclick="closePanel()"></div>

<!-- PROTEIN BREAKDOWN PANEL -->
<div class="drop-panel" id="panel-protein">
  <div class="drop-panel-hd"><h3>Protein Sources</h3><button class="drop-panel-close" onclick="closePanel()">‚úï</button></div>
  <div class="drop-panel-body" id="protein-breakdown-body"></div>
</div>

<!-- CUSTOM FOOD PANEL -->
<div class="drop-panel" id="panel-custom-food">
  <div class="drop-panel-hd"><h3>Add Custom Food</h3><button class="drop-panel-close" onclick="closePanel()">‚úï</button></div>
  <div class="drop-panel-body">
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button class="btn btn-primary btn-sm" onclick="startBarcode()" style="flex:1;">üì∑ Scan Barcode</button>
      <button class="btn btn-ghost btn-sm" onclick="startLabelPhoto()" style="flex:1;">üè∑ Photo Label</button>
    </div>
    <!-- Barcode scanner -->
    <div id="barcode-wrap" class="scan-overlay" style="margin-bottom:10px;">
      <video id="barcode-video" autoplay muted playsinline></video>
      <canvas id="barcode-canvas" style="display:none;"></canvas>
      <div class="scan-corners"></div>
      <div class="scan-status" id="barcode-status">Point camera at barcode...</div>
      <div style="display:flex;gap:8px;padding:8px;justify-content:center;">
        <button class="btn btn-primary btn-sm" onclick="captureFrame()">üì∏ Capture Now</button>
        <button class="btn btn-ghost btn-sm" onclick="stopBarcode()">Cancel</button>
      </div>
    </div>
    <!-- Label photo -->
    <div id="label-wrap" style="display:none;margin-bottom:12px;">
      <label class="btn btn-ghost" style="width:100%;justify-content:center;cursor:pointer;margin-bottom:8px;">
        üì∑ Take / Choose Photo
        <input type="file" id="label-input" accept="image/*" capture="environment" style="display:none;" onchange="processLabel(event)">
      </label>
      <div id="label-preview" style="display:none;"><img id="label-img" style="width:100%;border-radius:8px;margin-bottom:6px;"><div id="label-status" style="font-size:12px;color:var(--muted);"></div></div>
      <button class="btn btn-ghost btn-sm" onclick="cancelLabel()">Cancel</button>
    </div>
    <!-- Status bar -->
    <div id="cf-status" style="display:none;padding:8px 12px;border-radius:8px;font-size:12px;margin-bottom:10px;"></div>
    <hr class="divider" style="margin:10px 0;">
    <div class="sec-label">Food Details</div>
    <input class="inp" id="cf-name" placeholder="Food name..." style="margin-bottom:10px;" oninput="clearCfStatus()">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
      <div><div class="sec-label">Calories</div><input class="inp" id="cf-cal" type="number" placeholder="0"></div>
      <div><div class="sec-label">Protein (g)</div><input class="inp" id="cf-protein" type="number" placeholder="0"></div>
      <div><div class="sec-label">Carbs (g)</div><input class="inp" id="cf-carbs" type="number" placeholder="0"></div>
      <div><div class="sec-label">Fat (g)</div><input class="inp" id="cf-fat" type="number" placeholder="0"></div>
      <div><div class="sec-label">Fiber (g)</div><input class="inp" id="cf-fiber" type="number" placeholder="0"></div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-ghost btn-sm" onclick="estimateMacros()" id="estimate-btn">‚ú® Estimate Macros</button>
      <button class="btn btn-primary btn-sm" onclick="saveCustomFood()" style="flex:1;">‚≠ê Save Food</button>
    </div>
  </div>
</div>

<!-- SAVED CUSTOM FOODS PANEL -->
<div class="drop-panel" id="panel-saved-foods">
  <div class="drop-panel-hd"><h3>My Saved Foods</h3><button class="drop-panel-close" onclick="closePanel()">‚úï</button></div>
  <div class="drop-panel-body" id="saved-foods-body"></div>
</div>

<!-- COMPLETE DAY MODAL -->
<div class="modal-overlay" id="complete-day-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('complete-day-modal')">‚úï</button>
    <h2>Day Complete üèÅ</h2>

    <!-- Date picker row -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:10px 12px;background:var(--card2);border:1px solid var(--border);border-radius:8px;">
      <span style="font-size:13px;color:var(--muted);white-space:nowrap;">Saving for:</span>
      <input type="date" id="complete-day-date" class="inp" style="flex:1;padding:5px 10px;font-family:'DM Mono',monospace;font-size:13px;" onchange="onCompleteDateChange()">
      <button class="btn btn-ghost btn-sm" onclick="setCompleteDateToday()" id="complete-today-btn" style="display:none;white-space:nowrap;font-size:11px;">‚Üê Today</button>
    </div>
    <div id="complete-date-note" style="font-size:11px;color:var(--accent2);margin-bottom:12px;display:none;">
      üìÖ Saving as a backdated entry ‚Äî current meal data will be logged for this date. Daily state will not reset.
    </div>

    <div class="modal-sub" id="modal-date"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;" id="modal-stats"></div>
    <div id="modal-highlights" style="margin-bottom:16px;font-size:13px;line-height:1.9;color:var(--muted);"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-primary" style="flex:1;" id="complete-save-btn" onclick="confirmCompleteDay(false)">‚úÖ Save & Reset</button>
      <button class="btn btn-ghost" id="complete-save-only-btn" style="display:none;flex:1;" onclick="confirmCompleteDay(true)">üíæ Save Only</button>
      <button class="btn btn-ghost" onclick="closeModal('complete-day-modal')">Not yet</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & DEFAULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_CLIENT_ID = '887919041364-o60kbhem4dc2s57djctvo4lafa31j3bj.apps.googleusercontent.com';

const FOODS = [
  { name:'Oikos Pro Drink', cal:170, protein:23, carbs:14, fat:3.5, fiber:0, icon:'ü•õ', note:'Easy protein hit' },
  { name:'Tyson Diced Chicken Breast (4oz)', cal:130, protein:22, carbs:0, fat:3, fiber:0, icon:'üçó', note:'Lean muscle fuel' },
  { name:'Marketside Caesar Salad', cal:320, protein:17, carbs:22, fat:18, fiber:3, icon:'ü•ó', note:'' },
  { name:'Marketside Cobb Salad', cal:280, protein:12, carbs:16, fat:17, fiber:4, icon:'ü•ó', note:'' },
  { name:'Marie Callender Frozen Meal', cal:380, protein:19, carbs:42, fat:12, fiber:4, icon:'üç±', note:'~18-20g protein avg' },
  { name:'Kemps 2% Cottage Cheese (¬Ω cup)', cal:100, protein:13, carbs:5, fat:2.5, fiber:0, icon:'üßÄ', note:'Casein = slow release' },
  { name:'Egg (1 large)', cal:72, protein:6, carbs:0.5, fat:5, fiber:0, icon:'ü•ö', note:'Complete protein' },
  { name:'Baby Spinach (1 cup)', cal:7, protein:0.9, carbs:1, fat:0.1, fiber:0.7, icon:'üåø', note:'' },
  { name:'Avocado (¬Ω)', cal:120, protein:1.5, carbs:6, fat:11, fiber:5, icon:'ü•ë', note:'Healthy fats' },
  { name:'Broccoli Florets (1 cup)', cal:31, protein:2.6, carbs:6, fat:0.3, fiber:2.4, icon:'ü•¶', note:'' },
  { name:'Freeze Dried Apples (¬Ω cup)', cal:50, protein:0, carbs:10, fat:0, fiber:1, icon:'üçé', note:'' },
  { name:'Frego Cheese Stick', cal:70, protein:6, carbs:1, fat:4.5, fiber:0, icon:'üßÄ', note:'' },
  { name:'Honey Nut Granola (1oz)', cal:120, protein:2, carbs:22, fat:3, fiber:2, icon:'üåæ', note:'Cheerios brand' },
  { name:'Bare Baked Apple Chips (1oz)', cal:110, protein:0, carbs:28, fat:0, fiber:4, icon:'üçé', note:'Good fiber' },
  { name:'Pretzel Crisps Garlic Parmesan (1oz)', cal:110, protein:3, carbs:22, fat:1.5, fiber:1, icon:'ü•®', note:'' },
  { name:'Buttermilk Ranch Rice Crisps (1oz)', cal:120, protein:2, carbs:22, fat:3, fiber:0, icon:'üçò', note:'' },
  { name:'Cheese Slice', cal:113, protein:7, carbs:0.5, fat:9, fiber:0, icon:'üßÄ', note:'' },
];

const MEAL_ORDER = ['Breakfast','Morning Snack','Lunch','Afternoon Snack','Dinner','Evening Snack'];

const ENERGY_LABELS = ['','üò¥ Wiped','üò© Very Low','üòï Low','üòê Below Avg','üôÇ Moderate','üòä Pretty Good','üí™ Good','üî• Strong','‚ö° Very High','üöÄ On Fire!'];
const MOODS = [{e:'üò¥',l:'Tired'},{e:'üò£',l:'Nauseous'},{e:'üòê',l:'OK'},{e:'üôÇ',l:'Good'},{e:'üî•',l:'Great'}];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = {
  water: +( localStorage.getItem('fs-water') || 0 ),
  energy: localStorage.getItem('fs-energy') ? +localStorage.getItem('fs-energy') : null,
  mood: localStorage.getItem('fs-mood') !== null && localStorage.getItem('fs-mood') !== '' ? +localStorage.getItem('fs-mood') : null,
  goalProtein: +( localStorage.getItem('fs-goal-protein') || 150 ),
  goalCal: +( localStorage.getItem('fs-goal-cal') || 1800 ),
  mealLog: JSON.parse( localStorage.getItem('fs-meals') || '{}' ),
  evoltHistory: JSON.parse( localStorage.getItem('fs-evolt') || '[]' ),
  history: JSON.parse( localStorage.getItem('fs-history') || '[]' ),
  customFoods: JSON.parse( localStorage.getItem('fs-custom-foods') || '[]' ),
  dayPlans: JSON.parse( localStorage.getItem('fs-dayplans') || '[]' ),
  workoutTime: localStorage.getItem('fs-workouttime') || null,
  training: { trained: null, muscles: [], postProtein: null },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(id, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  el.classList.add('active');
  if (id === 'timing') renderTimingList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SLIDE-OUT PANELS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPanel(id) {
  closePanel(false);
  if (id === 'panel-protein') renderProteinBreakdown();
  if (id === 'panel-saved-foods') renderSavedFoods();
  document.getElementById(id).classList.add('open');
  document.getElementById('panel-overlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closePanel(restore = true) {
  document.querySelectorAll('.drop-panel').forEach(p => p.classList.remove('open'));
  document.getElementById('panel-overlay').style.display = 'none';
  if (restore) document.body.style.overflow = '';
  stopBarcode();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function todayKey() { return new Date().toISOString().split('T')[0]; }
function initDate() {
  document.getElementById('header-date').textContent = new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
}
function formatTime(t) {
  if (!t) return '';
  const [h,m] = t.split(':').map(Number);
  return `${h%12||12}:${String(m).padStart(2,'0')} ${h>=12?'PM':'AM'}`;
}
function addMins(t, mins) {
  const [h,m] = t.split(':').map(Number);
  const tot = h*60+m+mins;
  return `${String(Math.floor(tot/60)%24).padStart(2,'0')}:${String(((tot%60)+60)%60).padStart(2,'0')}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW DAY CHECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkNewDay() {
  const last = localStorage.getItem('fs-today');
  const today = todayKey();
  if (last && last !== today) resetDailyState(false);
  localStorage.setItem('fs-today', today);
}
function resetDailyState(notify = true) {
  S.mealLog = {}; S.water = 0; S.energy = null; S.mood = null; S.dayPlans = []; S.workoutTime = null;
  S.training = { trained: null, muscles: [], postProtein: null };
  ['fs-meals','fs-water','fs-energy','fs-mood','fs-dayplans','fs-workouttime'].forEach(k => localStorage.removeItem(k));
  renderAll();
  if (notify) showToast('üåÖ Fresh day started!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WATER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addWater(n) { S.water = Math.max(0, Math.min(120, S.water + n)); save(); renderWater(); }
function renderWater() {
  const oz = S.water, el = document.getElementById('water-drops');
  el.innerHTML = '';
  for (let i=0;i<8;i++) {
    const seg = (i+1)*10;
    const d = document.createElement('div');
    d.className = 'drop' + (oz>=seg?' on':oz>i*10?' half':'');
    d.textContent = 'üíß';
    d.title = seg+'oz';
    d.onclick = () => { S.water = oz>=seg ? i*10 : seg; save(); renderWater(); };
    el.appendChild(d);
  }
  document.getElementById('water-count').textContent = `${oz} / 80 oz`;
  document.getElementById('tot-water').textContent = oz;
  updateRings();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENERGY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateEnergy(v) {
  S.energy = +v;
  document.getElementById('energy-display').textContent = v;
  document.getElementById('energy-label').textContent = ENERGY_LABELS[v];
  document.getElementById('tot-energy').textContent = v+'/10';
  document.getElementById('energy-stat-sub').textContent = ENERGY_LABELS[v];
  save();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOOD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMood() {
  const row = document.getElementById('mood-row');
  row.innerHTML = MOODS.map((m,i) => `
    <div class="mood-btn ${S.mood===i?'on':''}" onclick="setMood(${i})">
      <div>${m.e}</div><div class="mood-lbl">${m.l}</div>
    </div>`).join('');
}
function setMood(i) { S.mood = i; save(); renderMood(); }
function saveMoodNote() { save(); showToast('Note saved üìù'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOALS (auto from Evolt)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcGoalsFromEvolt(entry) {
  if (!entry) return;
  const wt = entry.wt, bmr = entry.bmr;
  if (!wt && !bmr) return;

  // Use Goals Profile multipliers if profile is set
  if (GP.primary) {
    recalcGoalsFromProfile(entry);
    return;
  }

  // Fallback to legacy calculation if no profile set
  if (wt) {
    S.goalProtein = Math.round(wt * 0.8);
    localStorage.setItem('fs-goal-protein', S.goalProtein);
  }
  if (bmr) {
    S.goalCal = Math.round(bmr * 1.35);
    localStorage.setItem('fs-goal-cal', S.goalCal);
  }
  updateGoalDisplays();
}
function updateGoalDisplays() {
  document.getElementById('goal-protein-disp').textContent = S.goalProtein;
  document.getElementById('goal-cal-disp').textContent = S.goalCal;
  document.getElementById('goal-protein-input').value = S.goalProtein;
  document.getElementById('goal-cal-input').value = S.goalCal;
  updateRings(); updateTotals(); updateInsights();
}
function saveGoals() {
  const p = +document.getElementById('goal-protein-input').value;
  const c = +document.getElementById('goal-cal-input').value;
  if (p>0) { S.goalProtein = p; localStorage.setItem('fs-goal-protein', p); }
  if (c>0) { S.goalCal = c; localStorage.setItem('fs-goal-cal', c); }
  updateGoalDisplays();
  document.getElementById('goals-source').textContent = 'Manually set';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateRings() {
  const totP = getTotalProtein(), totC = getTotalCal(), totW = S.water;
  const pPct = Math.min(100, Math.round(totP/S.goalProtein*100));
  const cPct = Math.min(100, Math.round(totC/S.goalCal*100));
  const wPct = Math.min(100, Math.round(totW/80*100));
  setRing('ring-p', pPct); document.getElementById('ring-p-val').textContent = pPct+'%';
  setRing('ring-c', cPct); document.getElementById('ring-c-val').textContent = cPct+'%';
  setRing('ring-w', wPct); document.getElementById('ring-w-val').textContent = wPct+'%';
}
function setRing(id, pct) {
  const circ = 2*Math.PI*43;
  document.getElementById(id).setAttribute('stroke-dasharray', `${(pct/100)*circ} ${circ}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FOOD + MEALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getAllFoods() { return [...FOODS, ...S.customFoods]; }
function getTotalProtein() { return Object.values(S.mealLog).flat().reduce((a,i)=>a+i.protein,0); }
function getTotalCal() { return Object.values(S.mealLog).flat().reduce((a,i)=>a+i.cal,0); }
function getTotalFiber() { return Object.values(S.mealLog).flat().reduce((a,i)=>a+i.fiber,0); }

function filterFoods() {
  const q = document.getElementById('food-search').value.toLowerCase();
  renderFoodList(q ? getAllFoods().filter(f => f.name.toLowerCase().includes(q)) : getAllFoods(), q);
}
function renderFoodList(foods, hl = '') {
  const el = document.getElementById('food-list');
  if (!foods.length) { el.innerHTML = `<div style="color:var(--muted);text-align:center;padding:20px;font-size:13px;">No results for "${hl}"</div>`; return; }
  el.innerHTML = '';
  foods.forEach((f, i) => {
    const row = document.createElement('div');
    row.className = 'food-row';
    row.style.cursor = 'default';
    const hlName = hl ? f.name.replace(new RegExp(hl,'gi'), m=>`<mark style="background:rgba(0,229,160,.25);color:var(--text);border-radius:2px;">${m}</mark>`) : f.name;
    row.innerHTML = `
      <div style="flex:1;min-width:0;">
        <div class="food-name">${f.icon||'üçΩ'} ${hlName}</div>
        <div class="food-meta">${f.cal} kcal${f.note?' ¬∑ '+f.note:''}</div>
        <div style="display:flex;gap:5px;margin-top:4px;flex-wrap:wrap;">
          <span class="badge bp">${f.protein}g P</span>
          <span class="badge bc">${f.carbs}g C</span>
          ${f.fiber>0?`<span class="badge bf">${f.fiber}g fiber</span>`:''}
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:7px;flex-shrink:0;margin-left:8px;">
        <input type="number" value="1" min="0.5" step="0.5" id="qty-${i}"
          style="width:46px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:4px;font-size:12px;font-family:'DM Mono',monospace;text-align:center;outline:none;"
          onclick="event.stopPropagation()">
        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();addToMeal(this.parentElement.parentElement._food, +document.getElementById('qty-${i}').value||1)">+</button>
      </div>`;
    row._food = f;
    el.appendChild(row);
  });
}
function addToMeal(food, qty=1) {
  qty = Math.max(0.5, qty);
  const meal = document.getElementById('meal-target').value;
  const ti = document.getElementById('meal-time').value;
  const now = new Date();
  const t = ti || `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  if (!S.mealLog[meal]) S.mealLog[meal] = [];
  S.mealLog[meal].push({
    ...food,
    qty, cal: Math.round(food.cal*qty),
    protein: Math.round(food.protein*qty*10)/10,
    carbs: Math.round(food.carbs*qty*10)/10,
    fat: Math.round(food.fat*qty*10)/10,
    fiber: Math.round(food.fiber*qty*10)/10,
    displayName: qty!==1?`${food.name} √ó${qty}`:food.name,
    timeLogged: t,
  });
  save(); renderMealLog(); updateTotals(); updateInsights();
  showToast(`‚úì ${qty>1?qty+'√ó ':''}${food.name} ‚Üí ${meal}`);
}
let pendingRemove = null, removeTimer = null;
function removeFromMeal(meal, idx) {
  // Store the removed item in case user wants to undo
  const removed = S.mealLog[meal]?.[idx];
  if (!removed) return;
  S.mealLog[meal].splice(idx, 1);
  if (!S.mealLog[meal].length) delete S.mealLog[meal];
  save(); renderMealLog(); updateTotals(); updateInsights();

  // Show undo toast
  clearTimeout(removeTimer);
  pendingRemove = { meal, item: removed };
  const t = document.getElementById('toast');
  t.innerHTML = `Removed ${removed.name} <button onclick="undoRemove()" style="margin-left:10px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.3);color:#000;padding:2px 8px;border-radius:4px;cursor:pointer;font-weight:700;font-size:12px;">Undo</button>`;
  t.classList.add('show');
  removeTimer = setTimeout(() => { t.classList.remove('show'); t.textContent=''; pendingRemove=null; }, 4000);
}
function undoRemove() {
  if (!pendingRemove) return;
  const { meal, item } = pendingRemove;
  if (!S.mealLog[meal]) S.mealLog[meal] = [];
  S.mealLog[meal].push(item);
  pendingRemove = null;
  clearTimeout(removeTimer);
  document.getElementById('toast').classList.remove('show');
  save(); renderMealLog(); updateTotals(); updateInsights();
  showToast(`‚Ü©Ô∏è ${item.name} restored`);
}
function renderMealLog() {
  const el = document.getElementById('meal-log-container');
  let tP=0, tC=0, tF=0;
  const html = [];
  MEAL_ORDER.forEach(meal => {
    const items = S.mealLog[meal]||[];
    if (!items.length) return;
    const mP = items.reduce((a,i)=>a+i.protein,0);
    const mC = items.reduce((a,i)=>a+i.cal,0);
    html.push(`<div style="margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);margin-bottom:6px;">
        <span style="font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:.5px;">${meal}</span>
        <span style="font-size:11px;color:var(--muted);">${mP}g P ¬∑ ${mC} kcal</span>
      </div>
      ${items.map((item,idx)=>`
        <div class="meal-entry">
          <div style="flex:1;min-width:0;">
            <div class="meal-entry-name">${item.icon||'üçΩ'} ${item.displayName||item.name}</div>
            <div class="meal-entry-meta">${item.cal} kcal ¬∑ ${item.protein}g P ¬∑ ${item.carbs}g C${item.fiber>0?` ¬∑ ${item.fiber}g fiber`:''}${item.timeLogged?` ¬∑ <span style="color:var(--accent);font-family:'DM Mono',monospace;font-size:10px;">${formatTime(item.timeLogged)}</span>`:''}</div>
          </div>
          <button class="rm-btn" onclick="removeFromMeal('${meal}',${idx})">‚úï</button>
        </div>`).join('')}
    </div>`);
    tP+=mP; tC+=mC; tF+=items.reduce((a,i)=>a+i.fiber,0);
  });
  el.innerHTML = html.join('') || '<div style="color:var(--muted);font-size:13px;text-align:center;padding:30px;">No meals logged yet</div>';
  document.getElementById('sum-protein').textContent = tP+'g';
  document.getElementById('sum-cal').textContent = tC;
  document.getElementById('sum-fiber').textContent = tF.toFixed(1)+'g';
  // Update today summary on Today tab
  renderTodaySummary();
}
function renderTodaySummary() {
  const el = document.getElementById('today-meal-summary');
  const meals = MEAL_ORDER.filter(m => S.mealLog[m]?.length);
  if (!meals.length) { el.textContent = 'No meals logged yet.'; el.style.color = 'var(--muted)'; return; }
  el.style.color = '';
  el.innerHTML = meals.map(m => {
    const items = S.mealLog[m];
    const p = items.reduce((a,i)=>a+i.protein,0);
    const c = items.reduce((a,i)=>a+i.cal,0);
    return `<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px;">
      <span>${m}</span>
      <span style="color:var(--muted);"><span style="color:var(--accent3);font-family:'DM Mono',monospace;">${p}g P</span> ¬∑ ${c} kcal</span>
    </div>`;
  }).join('') + `<div style="margin-top:8px;font-size:12px;color:var(--muted);text-align:right;">Total: <span style="color:var(--accent3);font-family:'DM Mono',monospace;">${getTotalProtein()}g protein</span> ¬∑ ${getTotalCal()} kcal</div>`;
}
function updateTotals() {
  const tP = getTotalProtein(), tC = getTotalCal();
  document.getElementById('tot-protein').textContent = tP;
  document.getElementById('tot-cal').textContent = tC;
  updateRings();
  updateSimpleMode();
  // Refresh timing tab if it's visible
  if (document.getElementById('tab-timing').classList.contains('active')) renderTimingList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROTEIN BREAKDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProteinBreakdown() {
  const items = [];
  MEAL_ORDER.forEach(meal => (S.mealLog[meal]||[]).forEach(item => {
    if (item.protein>0) items.push({meal, name:item.displayName||item.name, protein:item.protein, icon:item.icon||'üçΩ', time:item.timeLogged});
  }));
  const el = document.getElementById('protein-breakdown-body');
  if (!items.length) { el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:30px;">No protein logged yet</div>'; return; }
  items.sort((a,b)=>b.protein-a.protein);
  const total = items.reduce((a,i)=>a+i.protein,0);
  el.innerHTML = `<div style="font-size:13px;color:var(--muted);margin-bottom:16px;">Total: <strong style="color:var(--accent3);font-family:'DM Mono',monospace;">${total}g / ${S.goalProtein}g</strong> (${Math.round(total/S.goalProtein*100)}%)</div>` +
    items.map(item => {
      const pct = Math.round(item.protein/total*100);
      return `<div style="margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <span style="font-size:13px;">${item.icon} ${item.name}</span>
          <span style="font-family:'DM Mono',monospace;color:var(--accent3);font-weight:700;">${item.protein}g</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden;">
            <div style="height:100%;width:${pct}%;background:var(--accent3);border-radius:3px;"></div>
          </div>
          <span style="font-size:10px;color:var(--muted);min-width:28px;text-align:right;">${pct}%</span>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">${item.time?formatTime(item.time)+' ¬∑ ':''}${item.meal}</div>
      </div>`;
    }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAY PLANS (multi-select toggle)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDayPlan(plan, btn) {
  const idx = S.dayPlans.indexOf(plan);
  if (idx === -1) S.dayPlans.push(plan);
  else S.dayPlans.splice(idx, 1);
  renderDayPlanBtns();
  document.getElementById('workout-time-row').style.display = S.dayPlans.includes('workout') ? 'block' : 'none';
  save(); updateInsights();
}
function renderDayPlanBtns() {
  document.querySelectorAll('.day-plan-btn').forEach(b => {
    const on = S.dayPlans.includes(b.dataset.plan);
    b.classList.toggle('btn-active', on);
    b.classList.toggle('btn-ghost', !on);
    b.classList.toggle('btn-sm', true);
  });
}
function saveWorkoutTime() {
  S.workoutTime = document.getElementById('workout-time').value;
  localStorage.setItem('fs-workouttime', S.workoutTime);
  updateWorkoutStatus(); updateInsights();
}
function minsToWorkout() {
  if (!S.workoutTime) return null;
  const [wh,wm] = S.workoutTime.split(':').map(Number);
  const now = new Date(), wo = new Date();
  wo.setHours(wh,wm,0,0);
  return Math.round((wo-now)/60000);
}
function updateWorkoutStatus() {
  const el = document.getElementById('workout-time-status');
  const mins = minsToWorkout();
  if (!el||mins===null) return;
  if (mins<0) {
    const ago = Math.abs(mins);
    el.style.color = ago<90?'var(--accent2)':'var(--muted)';
    el.textContent = ago<90?`‚ö° Workout was ${ago} min ago ‚Äî post-workout window open!`:`‚úì Workout completed ${(ago/60).toFixed(1)} hrs ago`;
  } else if (mins<60) { el.style.color='var(--yellow)'; el.textContent=`‚ö†Ô∏è Workout in ${mins} min ‚Äî pre-workout meal NOW`; }
  else if (mins<180) { el.style.color='var(--accent3)'; el.textContent=`üïê Workout in ${(mins/60).toFixed(1)} hrs ‚Äî pre-workout window open`; }
  else { el.style.color='var(--muted)'; el.textContent=`üèãÔ∏è Workout at ${formatTime(S.workoutTime)} ‚Äî ${(mins/60).toFixed(1)} hrs away`; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DYNAMIC INSIGHTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateInsights() {
  const el = document.getElementById('dynamic-insights');
  if (!el) return;
  const tP = getTotalProtein(), tC = getTotalCal();
  const proteinLeft = Math.max(0, S.goalProtein - tP);
  const remaining = MEAL_ORDER.filter(m => !(S.mealLog[m]?.length));
  const insights = [];

  // Goal-aware header insight (only if profile set, no day plan yet)
  if (GP.primary && !S.dayPlans.length) {
    const goalPrompts = {
      recomp: { icon:'‚öñÔ∏è', color:'var(--accent)', title:'Body Recomp Day ‚Äî set your plan above', body:`Hit <strong>${S.goalProtein}g protein</strong> to build muscle while running a deficit. Set your day plan above for timing-specific guidance.`, bg:'rgba(0,229,160,.07)', border:'rgba(0,229,160,.18)' },
      muscle:  { icon:'üí™', color:'var(--accent3)', title:'Build Muscle Day ‚Äî set your plan above', body:`Protein is everything today ‚Äî target <strong>${S.goalProtein}g</strong>. Set your day plan for workout timing cues.`, bg:'rgba(77,168,255,.07)', border:'rgba(77,168,255,.18)' },
      fat_loss:{ icon:'üî•', color:'var(--accent2)', title:'Fat Loss Day ‚Äî set your plan above', body:`Stay under <strong>${S.goalCal} kcal</strong> while hitting <strong>${S.goalProtein}g protein</strong> to preserve muscle. Set your day plan for today.`, bg:'rgba(255,107,53,.07)', border:'rgba(255,107,53,.18)' },
      maintain:{ icon:'üéØ', color:'var(--yellow)', title:'Maintenance Day ‚Äî set your plan above', body:`Target: <strong>${S.goalProtein}g protein</strong> ¬∑ <strong>${S.goalCal} kcal</strong>. Set your day plan to get personalized insights.`, bg:'rgba(255,212,96,.07)', border:'rgba(255,212,96,.18)' },
      track:   { icon:'üìä', color:'var(--muted)', title:'Tracking today', body:`Logging your intake. Tap a day plan above if you want coaching insights.`, bg:'rgba(90,106,128,.07)', border:'rgba(90,106,128,.18)' },
    };
    if (goalPrompts[GP.primary]) insights.push(goalPrompts[GP.primary]);
  } else if (!GP.primary && !S.dayPlans.length) {
    insights.push({ icon:'üéØ', color:'var(--accent)', title:'Set your Goals Profile in Settings', body:"Go to ‚öôÔ∏è Settings ‚Üí Goals Profile to tell me about your goals ‚Äî I'll give you personalized insights and coaching.", bg:'rgba(0,229,160,.07)', border:'rgba(0,229,160,.18)' });
  }

  if (S.dayPlans.length) {
    // Training
    if (S.dayPlans.includes('workout')) {
      const mins = minsToWorkout();
      if (S.workoutTime && mins !== null) {
        if (mins > 180) {
          insights.push({ icon:'üìã', color:'var(--accent3)', title:`Training at ${formatTime(S.workoutTime)} ‚Äî nutrition roadmap`, body:`<strong>${(mins/60).toFixed(1)} hrs</strong> to go. Plan: pre-workout meal at <strong>${formatTime(addMins(S.workoutTime,-90))}</strong> (~30g P + carbs), post-workout by <strong>${formatTime(addMins(S.workoutTime,60))}</strong> (~40g P).`, bg:'rgba(77,168,255,.07)', border:'rgba(77,168,255,.18)' });
        } else if (mins > 60) {
          insights.push({ icon:'‚è∞', color:'var(--yellow)', title:`Pre-workout window ‚Äî ${(mins/60).toFixed(1)} hrs to go`, body:tP>=20?`‚úÖ You've got <strong>${tP}g protein</strong> in. Eat your pre-workout meal now ‚Äî target <strong>30g P + carbs</strong>.`:`Pre-workout window. Eat <strong>30g protein + carbs now</strong>. Try: 2 eggs + cottage cheese + granola.`, bg:'rgba(255,212,96,.08)', border:'rgba(255,212,96,.22)' });
        } else if (mins > 0) {
          insights.push({ icon:'üö®', color:'var(--accent2)', title:`Workout in ${mins} min`, body:tP>=25?`Fueled at <strong>${tP}g protein</strong>. Grab fast carbs if low energy. Keep the meal light now.`:`<strong>Grab an Oikos Pro NOW</strong> ‚Äî 23g protein, fast absorbing, won't sit heavy.`, bg:'rgba(255,107,53,.09)', border:'rgba(255,107,53,.25)' });
        } else {
          const ago = Math.abs(mins);
          insights.push({ icon:ago<90?'‚ö°':'üîß', color:ago<90?'var(--accent2)':'var(--purple)', title:ago<90?`Post-workout window ‚Äî ${90-ago} min left!`:`Recovery mode`, body:ago<90?`Get <strong>40g protein NOW</strong> ‚Äî Tyson chicken + Oikos Pro. Don't miss this window.`:`Post-workout window passed. You've logged <strong>${tP}g</strong> ‚Äî need <strong>${proteinLeft}g more</strong> today.`, bg:ago<90?'rgba(255,107,53,.09)':'rgba(180,127,255,.07)', border:ago<90?'rgba(255,107,53,.25)':'rgba(180,127,255,.18)' });
        }
      } else {
        insights.push({ icon:'üí™', color:'var(--accent3)', title:'Training Day ‚Äî add workout time above for smart cues', body:`General plan: 30g pre-workout, 40g post-workout, rest spread across meals. Total goal: <strong>${S.goalProtein}g protein</strong>.`, bg:'rgba(77,168,255,.07)', border:'rgba(77,168,255,.18)' });
      }
    }
    // Injection (only if GLP-1 flagged)
    if (S.dayPlans.includes('injection') && GP.flags.includes('glp1')) {
      insights.push({ icon:'üíâ', color:'var(--accent2)', title:'Injection Day ‚Äî plan your protein ahead', body:`Appetite will drop in 24‚Äì48 hrs. Pre-log protein now. Liquid options: Oikos Pro, cottage cheese. <strong>Goal: ${S.goalProtein}g even when not hungry.</strong>`, bg:'rgba(255,107,53,.07)', border:'rgba(255,107,53,.18)' });
    }
    // Recovery
    if (S.dayPlans.includes('recover') && !S.dayPlans.includes('workout')) {
      insights.push({ icon:'üîß', color:'var(--purple)', title:'Recovery Day ‚Äî muscle gets built today', body:`Keep protein high at <strong>${S.goalProtein}g</strong>. Drop calories slightly to ~${S.goalCal-200} kcal. Cottage cheese before bed = overnight repair.`, bg:'rgba(180,127,255,.07)', border:'rgba(180,127,255,.18)' });
    }
  }

  // Fat loss specific calorie check
  if (GP.primary === 'fat_loss' && tC > 0 && tC > S.goalCal * 0.9) {
    const over = tC - S.goalCal;
    if (over > 0) insights.push({ icon:'‚ö†Ô∏è', color:'var(--accent2)', title:`Calorie alert ‚Äî ${over} kcal over goal`, body:`You're at <strong>${tC} kcal</strong> vs your <strong>${S.goalCal} kcal</strong> fat loss target. Keep remaining meals protein-dense and low-calorie.`, bg:'rgba(255,107,53,.07)', border:'rgba(255,107,53,.18)' });
  }

  // Protein progress (always show if there's data)
  if (tP > 0 && proteinLeft > 0 && remaining.length > 0) {
    const per = Math.ceil(proteinLeft/remaining.length);
    insights.push({ icon:'üìä', color:'var(--yellow)', title:`${tP}g logged ‚Äî ${proteinLeft}g to go`, body:`<strong>${remaining.length} meal slot${remaining.length!==1?'s':''}</strong> remaining. Aim for ~<strong>${per}g protein</strong> per meal.`, bg:'rgba(255,212,96,.06)', border:'rgba(255,212,96,.18)' });
  } else if (tP >= S.goalProtein && tP > 0) {
    insights.push({ icon:'üèÜ', color:'var(--accent)', title:'Protein goal hit! üéâ', body:`<strong>${tP}g</strong> ‚Äî goal crushed. ${GP.primary==='muscle'?'Muscle building locked in.':GP.primary==='fat_loss'?'And staying in your deficit? Perfect day.':'That\'s how progress is made.'}`, bg:'rgba(0,229,160,.07)', border:'rgba(0,229,160,.2)' });
  }

  el.innerHTML = insights.length ? `<div class="g2">${insights.map(i=>`
    <div class="insight" style="background:${i.bg};border-color:${i.border};margin-bottom:0;">
      <div style="display:flex;gap:8px;">
        <span style="font-size:16px;flex-shrink:0;">${i.icon}</span>
        <div>
          <div class="insight-title" style="color:${i.color};">${i.title}</div>
          <div class="insight-body">${i.body}</div>
        </div>
      </div>
    </div>`).join('')}</div>` : '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEAL TIMING TAB ‚Äî live, pulls from food log
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TIMING_BASE = [
  { meal:'Breakfast',         time:'9:00 AM',  color:'var(--yellow)',  targetP:35, desc:'2‚Äì3 eggs + cottage cheese + spinach. Add broccoli or apple chips for fiber.' },
  { meal:'Morning Snack',     time:'11:30 AM', color:'var(--accent)',   targetP:23, desc:'Oikos Pro (23g) or cheese sticks + granola. Quick protein bridge to lunch.' },
  { meal:'Lunch',             time:'1:30 PM',  color:'var(--accent3)', targetP:35, desc:'Caesar/Cobb Salad + Tyson chicken = up to 35g. Add avocado for healthy fats.' },
  { meal:'Afternoon Snack',   time:'4:00 PM',  color:'var(--accent2)', targetP:15, desc:'Cottage cheese + freeze-dried apples = ~15g protein. Great on tirzepatide days.' },
  { meal:'Dinner',            time:'6:30 PM',  color:'var(--purple)',  targetP:35, desc:'Marie Callender + Tyson chicken, or chicken + broccoli + cheese + avocado bowl.' },
  { meal:'Evening Snack',     time:'9:00 PM',  color:'var(--muted)',   targetP:15, desc:'Only if under protein goal: Oikos Pro or cottage cheese. Casein = overnight repair.' },
];

function initTiming() {
  renderTimingList();
  renderMealCombos();
}

function renderTimingList() {
  const el = document.getElementById('timing-list');
  const now = new Date();
  const nowMins = now.getHours() * 60 + now.getMinutes();

  // If workout time set, figure out pre/post windows
  const wt = S.workoutTime;
  let preWindowStart = null, postWindowEnd = null;
  if (wt) {
    const [wh, wm] = wt.split(':').map(Number);
    const workoutMins = wh * 60 + wm;
    preWindowStart = workoutMins - 120; // 2 hrs before
    postWindowEnd  = workoutMins + 90;  // 90 min after
  }

  el.innerHTML = TIMING_BASE.map((t, i) => {
    const logged = S.mealLog[t.meal] || [];
    const loggedP = logged.reduce((a,i) => a + i.protein, 0);
    const loggedCal = logged.reduce((a,i) => a + i.cal, 0);
    const isDone = logged.length > 0;

    // Parse slot time to minutes
    const [timePart, ampm] = t.time.split(' ');
    const [th, tm] = timePart.split(':').map(Number);
    const slotMins = (ampm === 'PM' && th !== 12 ? th + 12 : th) * 60 + (tm || 0);
    const isPast = slotMins < nowMins;
    const isCurrent = !isPast && slotMins - nowMins < 90;

    // Workout annotation
    let workoutTag = '';
    if (wt) {
      const [wh, wm] = wt.split(':').map(Number);
      const workoutMins = wh * 60 + wm;
      if (Math.abs(slotMins - (workoutMins - 90)) < 60) workoutTag = 'üèãÔ∏è Pre-Workout Window';
      else if (Math.abs(slotMins - (workoutMins + 45)) < 60) workoutTag = '‚ö° Post-Workout Window';
    }

    // Status dot color
    const dotColor = isDone ? 'var(--accent)' : isCurrent ? 'var(--yellow)' : isPast ? 'var(--danger)' : t.color;
    const cardBorder = isDone ? 'border-color:rgba(0,229,160,0.35);' : isCurrent ? 'border-color:rgba(255,212,96,0.35);' : isPast && !isDone ? 'border-color:rgba(255,69,96,0.25);' : '';

    // Build logged items HTML
    let loggedHtml = '';
    if (isDone) {
      loggedHtml = `<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px;">
        ${logged.map(f => `<div style="display:flex;justify-content:space-between;font-size:11px;padding:2px 0;">
          <span style="color:var(--text);">${f.icon||'üçΩ'} ${f.displayName||f.name}</span>
          <span style="color:var(--accent3);font-family:'DM Mono',monospace;">${f.protein}g P ¬∑ ${f.cal} kcal</span>
        </div>`).join('')}
        <div style="display:flex;justify-content:space-between;margin-top:5px;padding-top:5px;border-top:1px solid var(--border);">
          <span style="font-size:11px;font-weight:600;color:${loggedP >= t.targetP ? 'var(--accent)' : 'var(--accent2)'};">
            ${loggedP >= t.targetP ? '‚úÖ' : '‚ö†Ô∏è'} ${loggedP}g / ${t.targetP}g target
          </span>
          <span style="font-size:11px;color:var(--muted);">${loggedCal} kcal</span>
        </div>
      </div>`;
    } else if (isPast) {
      loggedHtml = `<div style="margin-top:6px;font-size:11px;color:var(--danger);">‚ö†Ô∏è Missed ‚Äî log retroactively in Food Log tab if needed</div>`;
    } else {
      loggedHtml = `<div style="margin-top:6px;font-size:11px;color:var(--muted);">Target: <strong style="color:${t.color};">${t.targetP}g protein</strong></div>`;
    }

    return `<div class="timing-row">
      <div style="display:flex;flex-direction:column;align-items:center;">
        <div class="timing-dot" style="color:${dotColor};background:${dotColor};"></div>
        ${i < TIMING_BASE.length - 1 ? `<div style="width:2px;flex:1;background:var(--border);min-height:24px;margin-top:3px;"></div>` : ''}
      </div>
      <div style="flex:1;padding-bottom:2px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px;">
          <div class="timing-time" style="color:${dotColor};">${t.time}</div>
          ${workoutTag ? `<span style="font-size:10px;font-weight:600;color:var(--accent3);background:rgba(77,168,255,0.1);padding:1px 7px;border-radius:99px;">${workoutTag}</span>` : ''}
          ${isDone ? `<span style="font-size:10px;font-weight:600;color:var(--accent);margin-left:auto;">‚úì Logged</span>` : isCurrent ? `<span style="font-size:10px;font-weight:600;color:var(--yellow);margin-left:auto;">‚ñ∂ Now</span>` : ''}
        </div>
        <div class="timing-card" style="${cardBorder}">
          <div class="timing-meal">${t.meal}</div>
          <div class="timing-desc">${t.desc}</div>
          ${loggedHtml}
        </div>
      </div>
    </div>`;
  }).join('');

  // Protein runway summary at bottom
  const totalP = getTotalProtein();
  const remaining = Math.max(0, S.goalProtein - totalP);
  const openSlots = TIMING_BASE.filter(t => !(S.mealLog[t.meal]?.length)).length;
  const perSlot = openSlots > 0 ? Math.ceil(remaining / openSlots) : 0;

  if (remaining > 0 && openSlots > 0) {
    el.innerHTML += `<div style="margin-top:14px;padding:12px;background:rgba(255,212,96,0.07);border:1px solid rgba(255,212,96,0.2);border-radius:8px;font-size:12px;">
      <div style="font-weight:600;color:var(--yellow);margin-bottom:4px;">üìä Protein Runway</div>
      <div style="color:var(--muted);">
        <strong style="color:var(--text);">${totalP}g</strong> logged ¬∑ <strong style="color:var(--text);">${remaining}g</strong> remaining ¬∑ 
        <strong style="color:var(--yellow);">${openSlots}</strong> meal slot${openSlots!==1?'s':''} left ¬∑ 
        aim for <strong style="color:var(--accent);">~${perSlot}g per meal</strong>
      </div>
    </div>`;
  } else if (remaining <= 0) {
    el.innerHTML += `<div style="margin-top:14px;padding:12px;background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.25);border-radius:8px;font-size:12px;font-weight:600;color:var(--accent);">
      üèÜ Protein goal hit! ${totalP}g logged ‚Äî muscle building locked in for today.
    </div>`;
  }
}

function renderMealCombos() {
  document.getElementById('meal-combos').innerHTML = [
    { label:'Quick Protein Bomb', items:'Oikos Pro + 2 eggs + Frego stick', p:35, cal:310 },
    { label:'Muscle Salad Bowl', items:'Caesar Salad + Tyson chicken + avocado', p:40, cal:470 },
    { label:'Cottage Power Bowl', items:'Kemps cottage cheese + 3 eggs + broccoli', p:38, cal:310 },
    { label:'Easy Day', items:'Marie Callender + Oikos Pro drink', p:42, cal:550 },
    { label:'High Fiber + Protein', items:'Cobb salad + Tyson chicken + apple chips', p:35, cal:500 },
  ].map(c=>`
    <div style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:7px;display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-weight:600;font-size:13px;margin-bottom:2px;">${c.label}</div>
        <div style="font-size:12px;color:var(--muted);">${c.items}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;margin-left:10px;">
        <div style="font-family:'DM Mono',monospace;font-size:13px;color:var(--accent3);">${c.p}g P</div>
        <div style="font-size:11px;color:var(--muted);">${c.cal} kcal</div>
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRAINING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTrained(v) {
  S.training.trained = v;
  document.getElementById('train-yes').classList.toggle('btn-active', v==='yes');
  document.getElementById('train-yes').classList.toggle('btn-ghost', v!=='yes');
  document.getElementById('train-rest').classList.toggle('btn-active', v==='rest');
  document.getElementById('train-rest').classList.toggle('btn-ghost', v!=='rest');
  if (v==='rest') { S.training.muscles=[]; document.querySelectorAll('.muscle-btn').forEach(b=>{b.classList.remove('btn-active');b.classList.add('btn-ghost');}); }
  renderTrainingInsight();
}
function toggleMuscle(btn) {
  if (S.training.trained!=='yes') { showToast('Mark today as training first'); return; }
  const g = btn.dataset.g;
  const idx = S.training.muscles.indexOf(g);
  if (idx===-1) S.training.muscles.push(g); else S.training.muscles.splice(idx,1);
  btn.classList.toggle('btn-active', S.training.muscles.includes(g));
  btn.classList.toggle('btn-ghost', !S.training.muscles.includes(g));
  renderTrainingInsight();
}
function setPostProtein(v) {
  S.training.postProtein = v;
  ['yes','no','na'].forEach(k => {
    document.getElementById('pp-'+k).classList.toggle('btn-active', v===k);
    document.getElementById('pp-'+k).classList.toggle('btn-ghost', v!==k);
    document.getElementById('pp-'+k).classList.toggle('btn-sm', true);
  });
  renderTrainingInsight();
}
function renderTrainingInsight() {
  const el = document.getElementById('training-insight');
  const t = S.training;
  if (!t.trained) { el.style.display='none'; return; }
  el.style.display='block';
  let txt='', icon='üí™';
  if (t.trained==='rest') { icon='üò¥'; txt='<strong>Rest day logged.</strong> Muscle is built during recovery. Hit your protein and water goals today.'; }
  else if (t.muscles.length && t.postProtein==='yes') { icon='üî•'; txt=`<strong>${t.muscles.join(', ')} trained ‚úì Post-workout protein ‚úì</strong> ‚Äî Perfect muscle-building combo. Hit your ${S.goalProtein}g protein for the day.`; }
  else if (t.muscles.length && t.postProtein==='no') { icon='‚ö†Ô∏è'; txt=`<strong>${t.muscles.join(', ')} ‚Äî no post-workout protein!</strong> Get an Oikos Pro or cottage cheese ASAP. The window is still open for a couple hours.`; }
  else if (t.muscles.length) { icon='üí™'; txt=`<strong>${t.muscles.join(', ')} trained.</strong> Log your post-workout protein status above.`; }
  else { txt='<strong>Training logged!</strong> Select your muscle groups to track your full history.'; }
  el.innerHTML = `<div style="display:flex;gap:8px;"><span style="font-size:16px;">${icon}</span><div class="insight-body">${txt}</div></div>`;
}
function saveTraining() {
  if (!S.training.trained) { showToast('Select trained or rest first'); return; }
  const checkins = JSON.parse(localStorage.getItem('fs-training')||'{}');
  checkins[todayKey()] = { ...S.training };
  localStorage.setItem('fs-training', JSON.stringify(checkins));
  autoSave(); showToast('‚úÖ Training saved!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVOLT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveEvolt() {
  const entry = {
    date: document.getElementById('ev-date').value || todayKey(),
    wt: parseFloat(document.getElementById('ev-wt').value)||null,
    bf: parseFloat(document.getElementById('ev-bf').value)||null,
    mm: parseFloat(document.getElementById('ev-mm').value)||null,
    lm: parseFloat(document.getElementById('ev-lm').value)||null,
    bmr: parseFloat(document.getElementById('ev-bmr').value)||null,
    vf: parseFloat(document.getElementById('ev-vf').value)||null,
    hyd: parseFloat(document.getElementById('ev-hyd').value)||null,
    fm: parseFloat(document.getElementById('ev-fm').value)||null,
  };
  S.evoltHistory.push(entry);
  localStorage.setItem('fs-evolt', JSON.stringify(S.evoltHistory));
  calcGoalsFromEvolt(entry);
  renderEvoltHistory();
  showGoalPreview(entry);
  autoSave(); showToast('‚úÖ Evolt scan saved! Goals updated.');
}
function showGoalPreview(entry) {
  const el = document.getElementById('goal-preview');
  if (!entry.wt && !entry.bmr) { el.style.display='none'; return; }
  el.style.display='block';
  const lines = [];
  if (entry.wt) {
    const lo = Math.round(entry.wt*0.7), hi = Math.round(entry.wt*1.0), mid = Math.round(entry.wt*0.8);
    lines.push(`<strong style="color:var(--accent);">Protein goal updated:</strong> <span style="font-family:'DM Mono',monospace;">${mid}g/day</span> (0.8 √ó ${entry.wt} lbs ¬∑ range ${lo}‚Äì${hi}g)`);
  }
  if (entry.bmr) {
    const cal = Math.round(entry.bmr*1.35);
    lines.push(`<strong style="color:var(--yellow);">Calorie goal updated:</strong> <span style="font-family:'DM Mono',monospace;">${cal} kcal/day</span> (BMR ${entry.bmr} √ó 1.35 activity)`);
  }
  el.innerHTML = lines.join('<br>');
}
function renderEvoltHistory() {
  const card = document.getElementById('evolt-history-card');
  const list = document.getElementById('evolt-history-list');
  if (!S.evoltHistory.length) { card.style.display='none'; return; }
  card.style.display='block';
  list.innerHTML = [...S.evoltHistory].reverse().map((e, ri) => {
    const realIdx = S.evoltHistory.length - 1 - ri; // index in original array
    return `
    <div style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--accent);">üìÖ ${e.date}</div>
        <button class="btn btn-ghost btn-sm" style="color:var(--danger);padding:3px 8px;font-size:11px;" onclick="deleteEvolt(${realIdx})">Delete</button>
      </div>
      <div class="bcomp-grid">
        ${e.bf!=null?`<div class="bcomp-tile"><div class="bcomp-val" style="color:var(--accent2)">${e.bf}%</div><div class="bcomp-lbl">Body Fat</div></div>`:''}
        ${e.mm!=null?`<div class="bcomp-tile"><div class="bcomp-val" style="color:var(--accent3)">${e.mm}</div><div class="bcomp-lbl">Muscle (lbs)</div></div>`:''}
        ${e.wt!=null?`<div class="bcomp-tile"><div class="bcomp-val" style="color:var(--text)">${e.wt}</div><div class="bcomp-lbl">Weight (lbs)</div></div>`:''}
        ${e.lm!=null?`<div class="bcomp-tile"><div class="bcomp-val" style="color:var(--accent)">${e.lm}</div><div class="bcomp-lbl">Lean Mass</div></div>`:''}
        ${e.bmr!=null?`<div class="bcomp-tile"><div class="bcomp-val" style="color:var(--yellow)">${e.bmr}</div><div class="bcomp-lbl">BMR (kcal)</div></div>`:''}
        ${e.vf!=null?`<div class="bcomp-tile"><div class="bcomp-val" style="color:var(--danger)">${e.vf}</div><div class="bcomp-lbl">Visceral Fat</div></div>`:''}
        ${e.fm!=null?`<div class="bcomp-tile"><div class="bcomp-val" style="color:var(--accent2)">${e.fm}</div><div class="bcomp-lbl">Fat Mass</div></div>`:''}
        ${e.hyd!=null?`<div class="bcomp-tile"><div class="bcomp-val" style="color:var(--accent3)">${e.hyd}</div><div class="bcomp-lbl">Body Water</div></div>`:''}
      </div>
    </div>`}).join('');
}
function deleteEvolt(idx) {
  const entry = S.evoltHistory[idx];
  if (!confirm(`Delete Evolt scan from ${entry.date}?`)) return;
  S.evoltHistory.splice(idx, 1);
  localStorage.setItem('fs-evolt', JSON.stringify(S.evoltHistory));
  renderEvoltHistory();
  showToast('Evolt scan deleted');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOM FOODS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clearCfStatus() { document.getElementById('cf-status').style.display='none'; }
function showCfStatus(msg, color) {
  const el = document.getElementById('cf-status');
  el.style.display='block';
  el.style.background = color==='ok'?'rgba(0,229,160,.08)':color==='warn'?'rgba(255,212,96,.08)':'rgba(255,107,53,.08)';
  el.style.color = color==='ok'?'var(--accent)':color==='warn'?'var(--yellow)':'var(--accent2)';
  el.style.border = `1px solid ${color==='ok'?'rgba(0,229,160,.2)':color==='warn'?'rgba(255,212,96,.2)':'rgba(255,107,53,.2)'}`;
  el.textContent = msg;
}
function saveCustomFood() {
  const name = document.getElementById('cf-name').value.trim();
  if (!name) { showToast('Enter a food name'); return; }
  const food = {
    name, icon:'üçΩ',
    cal: parseFloat(document.getElementById('cf-cal').value)||0,
    protein: parseFloat(document.getElementById('cf-protein').value)||0,
    carbs: parseFloat(document.getElementById('cf-carbs').value)||0,
    fat: parseFloat(document.getElementById('cf-fat').value)||0,
    fiber: parseFloat(document.getElementById('cf-fiber').value)||0,
  };
  S.customFoods.push(food);
  localStorage.setItem('fs-custom-foods', JSON.stringify(S.customFoods));
  ['cf-name','cf-cal','cf-protein','cf-carbs','cf-fat','cf-fiber'].forEach(id=>document.getElementById(id).value='');
  clearCfStatus();
  renderFoodList(getAllFoods());
  updateSavedBtn();
  closePanel();
  showToast(`‚≠ê ${name} saved!`);
}
function updateSavedBtn() {
  const n = S.customFoods.length;
  document.getElementById('saved-count').textContent = n;
  document.getElementById('saved-foods-btn').style.display = n>0?'inline-flex':'none';
}
function renderSavedFoods() {
  const el = document.getElementById('saved-foods-body');
  if (!S.customFoods.length) { el.innerHTML='<div style="color:var(--muted);text-align:center;padding:30px;">No saved foods yet</div>'; return; }
  el.innerHTML = S.customFoods.map((f,i)=>`
    <div class="food-row" style="margin-bottom:8px;">
      <div style="flex:1;">
        <div class="food-name">${f.icon||'üçΩ'} ${f.name}</div>
        <div class="food-meta">${f.cal} kcal ¬∑ ${f.protein}g P ¬∑ ${f.carbs}g C ¬∑ ${f.fat}g F</div>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0;margin-left:8px;">
        <button class="btn btn-primary btn-sm" onclick="addToMeal(${JSON.stringify(f).replace(/"/g,'&quot;')},1);closePanel();">+ Add</button>
        <button class="btn btn-ghost btn-sm" style="color:var(--danger);" onclick="deleteCustomFood(${i})">‚úï</button>
      </div>
    </div>`).join('');
}
function deleteCustomFood(idx) {
  S.customFoods.splice(idx,1);
  localStorage.setItem('fs-custom-foods', JSON.stringify(S.customFoods));
  renderSavedFoods(); renderFoodList(getAllFoods()); updateSavedBtn();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BARCODE SCANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let barcodeStream = null, barcodeInterval = null, barcodeDetector = null;

async function startBarcode() {
  const wrap = document.getElementById('barcode-wrap');
  const video = document.getElementById('barcode-video');
  const status = document.getElementById('barcode-status');
  wrap.classList.add('show');
  status.textContent = 'Starting camera...';
  try {
    barcodeStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }
    });
    video.srcObject = barcodeStream;
    await video.play();

    if ('BarcodeDetector' in window) {
      // Native BarcodeDetector ‚Äî auto-scan every 600ms AND allow manual capture
      barcodeDetector = new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','qr_code','code_128','code_39'] });
      status.textContent = 'Auto-scanning... or tap Capture Now';
      barcodeInterval = setInterval(async () => {
        try {
          const codes = await barcodeDetector.detect(video);
          if (codes.length) {
            clearInterval(barcodeInterval);
            status.textContent = `‚úÖ Found: ${codes[0].rawValue}`;
            stopBarcode();
            await lookupBarcode(codes[0].rawValue);
          }
        } catch(e) {}
      }, 600);
    } else {
      // iOS Safari / no BarcodeDetector ‚Äî manual capture only
      status.textContent = 'Tap "Capture Now" when barcode is centered';
    }
  } catch(e) {
    wrap.classList.remove('show');
    showToast('Camera not available ‚Äî try uploading a photo instead');
  }
}

// Manual capture: grabs current video frame, tries BarcodeDetector then AI fallback
async function captureFrame() {
  const video = document.getElementById('barcode-video');
  const canvas = document.getElementById('barcode-canvas');
  if (!video.videoWidth) { showToast('Camera not ready yet'); return; }

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const base64 = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];

  document.getElementById('barcode-status').textContent = 'Reading...';
  clearInterval(barcodeInterval);

  // Try native detector on the canvas first
  if (barcodeDetector) {
    try {
      const codes = await barcodeDetector.detect(canvas);
      if (codes.length) {
        stopBarcode();
        await lookupBarcode(codes[0].rawValue);
        return;
      }
    } catch(e) {}
  }

  // Fall back to AI barcode reading
  stopBarcode();
  await extractBarcodeFromImage(base64);
}

function stopBarcode() {
  if (barcodeStream) { barcodeStream.getTracks().forEach(t => t.stop()); barcodeStream = null; }
  clearInterval(barcodeInterval); barcodeInterval = null; barcodeDetector = null;
  document.getElementById('barcode-wrap').classList.remove('show');
}

async function extractBarcodeFromImage(base64) {
  showCfStatus('üîç Reading barcode with AI...', 'ok');
  try {
    const d = await callAI({
      model:'claude-sonnet-4-5', max_tokens:100,
      messages:[{ role:'user', content:[
        { type:'image', source:{ type:'base64', media_type:'image/jpeg', data:base64 }},
        { type:'text', text:'Find the barcode (UPC or EAN) number in this image. Return ONLY the digits, nothing else. If no barcode is visible, return "none".' }
      ]}]
    });
    const code = (d.content?.[0]?.text||'').trim().replace(/\D/g,'');
    if (code && code.length >= 8) await lookupBarcode(code);
    else showCfStatus('No barcode found ‚Äî try Photo Label or enter manually', 'warn');
  } catch(e) {
    if (e.message==='NO_KEY') showCfStatus('Add Anthropic API key in Settings','warn');
    else if (e.message==='NO_PROXY') showCfStatus('Add Proxy URL in Settings','warn');
    else showCfStatus('AI read failed ‚Äî enter manually', 'err');
  }
}

async function lookupBarcode(upc) {
  showCfStatus(`üîç Looking up ${upc}...`, 'ok');
  try {
    const r = await fetch(`https://world.openfoodfacts.org/api/v2/product/${upc}.json`);
    const d = await r.json();
    if (d.status !== 1) { showCfStatus(`Product ${upc} not found ‚Äî try Photo Label or enter manually`, 'warn'); return; }
    const p = d.product, n = p.nutriments || {};
    // Prefer serving-size values; fall back to per-100g with serving multiplier
    const servingG = parseFloat(p.serving_size) || 100;
    const mult = servingG / 100;
    const cal = Math.round(n['energy-kcal_serving'] || n['energy-kcal_100g'] * mult || 0);
    const protein = Math.round((n.proteins_serving ?? n.proteins_100g * mult ?? 0) * 10) / 10;
    const carbs = Math.round((n.carbohydrates_serving ?? n.carbohydrates_100g * mult ?? 0) * 10) / 10;
    const fat = Math.round((n.fat_serving ?? n.fat_100g * mult ?? 0) * 10) / 10;
    const fiber = Math.round((n.fiber_serving ?? n.fiber_100g * mult ?? 0) * 10) / 10;
    document.getElementById('cf-name').value = p.product_name || p.abbreviated_product_name || 'Unknown Product';
    document.getElementById('cf-cal').value = cal;
    document.getElementById('cf-protein').value = protein;
    document.getElementById('cf-carbs').value = carbs;
    document.getElementById('cf-fat').value = fat;
    document.getElementById('cf-fiber').value = fiber;
    showCfStatus(`‚úÖ Found: ${document.getElementById('cf-name').value} (per ${p.serving_size || '100g'})`, 'ok');
  } catch(e) { showCfStatus('Lookup failed ‚Äî enter manually', 'err'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LABEL PHOTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startLabelPhoto() {
  document.getElementById('label-wrap').style.display='block';
}
function cancelLabel() {
  document.getElementById('label-wrap').style.display='none';
  document.getElementById('label-preview').style.display='none';
}
async function processLabel(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (e) => {
    const base64 = e.target.result.split(',')[1];
    const mime = file.type || 'image/jpeg';
    document.getElementById('label-preview').style.display='block';
    document.getElementById('label-img').src = e.target.result;
    document.getElementById('label-status').textContent = 'üîç Reading label...';
    showCfStatus('Extracting nutrition data from label...','ok');

    try {
      const data = await callAI({
        model:'claude-sonnet-4-5', max_tokens:400,
        messages:[{role:'user',content:[
          {type:'image',source:{type:'base64',media_type:mime,data:base64}},
          {type:'text',text:`Extract the nutrition information from this label. The label may be in any format ‚Äî traditional stacked table OR a condensed single-paragraph format like "Calories 160, Total Fat 4.5g, Protein 9g..." Both formats are common and you should handle both.

Find the per-SERVING values (look for "Serving size" or "Serv. size" to understand the serving). Use the amount per serving, not per 100g.

Return ONLY a JSON object ‚Äî no preamble, no explanation, just the JSON:
{"name":"product name if visible in image, otherwise empty string","cal":number,"protein":number,"carbs":number,"fat":number,"fiber":number,"serving":"serving size e.g. 1 container (128g)"}

For fiber: if label says "<1g" use 0.5. If not listed, use 0.`}
        ]}]
      });
      const raw = data.content?.[0]?.text||'';
      const match = raw.match(/\{[\s\S]*?\}/);
      if (!match) throw new Error('no json');
      const est = JSON.parse(match[0]);
      if (est.name) document.getElementById('cf-name').value = est.name;
      document.getElementById('cf-cal').value = est.cal||'';
      document.getElementById('cf-protein').value = est.protein||'';
      document.getElementById('cf-carbs').value = est.carbs||'';
      document.getElementById('cf-fat').value = est.fat||'';
      document.getElementById('cf-fiber').value = est.fiber||'';
      document.getElementById('label-status').textContent = `‚úÖ Read: per ${est.serving||'serving'}`;
      showCfStatus(`‚úÖ Label read ‚Äî per ${est.serving||'serving'}. Review values and tap Save.`, 'ok');
    } catch(e) {
      document.getElementById('label-status').textContent = '‚ùå Could not read label';
      if (e.message==='NO_KEY') showCfStatus('Add Anthropic API key in Settings','warn');
      else if (e.message==='NO_PROXY') showCfStatus('Add Proxy URL in Settings','warn');
      else showCfStatus('Could not extract label data ‚Äî please enter manually','err');
    }
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MACRO ESTIMATION (AI)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function estimateMacros() {
  const name = document.getElementById('cf-name').value.trim();
  if (!name) { showToast('Enter a food name first'); return; }
  const btn = document.getElementById('estimate-btn');
  btn.disabled=true; btn.textContent='‚è≥...';
  showCfStatus('Estimating macros...','ok');
  try {
    const d = await callAI({
      model:'claude-sonnet-4-5', max_tokens:200,
      messages:[{role:'user',content:`Estimate nutrition for one standard serving of: "${name}"
Return ONLY JSON: {"cal":number,"protein":number,"carbs":number,"fat":number,"fiber":number,"serving":"description","confidence":"high/medium/low"}`}]
    });
    const match = (d.content?.[0]?.text||'').match(/\{[\s\S]*\}/);
    if (!match) throw new Error('no json');
    const est = JSON.parse(match[0]);
    if (!document.getElementById('cf-cal').value) document.getElementById('cf-cal').value=est.cal;
    if (!document.getElementById('cf-protein').value) document.getElementById('cf-protein').value=est.protein;
    if (!document.getElementById('cf-carbs').value) document.getElementById('cf-carbs').value=est.carbs;
    if (!document.getElementById('cf-fat').value) document.getElementById('cf-fat').value=est.fat;
    if (!document.getElementById('cf-fiber').value) document.getElementById('cf-fiber').value=est.fiber;
    showCfStatus(`‚úÖ Estimated for ${est.serving} ‚Äî confidence: ${est.confidence}. Edit any values before saving.`,'ok');
  } catch(e) {
    if (e.message==='NO_KEY') showCfStatus('Add Anthropic API key in Settings','warn');
    else if (e.message==='NO_PROXY') showCfStatus('Add Proxy URL in Settings','warn');
    else showCfStatus('Estimation failed ‚Äî enter manually','err');
  }
  btn.disabled=false; btn.textContent='‚ú® Estimate Macros';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOALS PROFILE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Default profile ‚Äî used until user explicitly saves one
const DEFAULT_GOALS_PROFILE = {
  primary: null,      // 'recomp' | 'muscle' | 'fat_loss' | 'maintain' | 'track'
  activity: null,     // 'sedentary' | 'light' | 'moderate' | 'very_active'
  flags: [],          // array: 'glp1','resistance','evolt','appetite_issues','high_protein'
  mode: 'full',       // 'full' | 'simple'
};

const ACTIVITY_MULTIPLIERS = {
  sedentary: 1.2, light: 1.375, moderate: 1.55, very_active: 1.725
};
const PROTEIN_MULTIPLIERS = {
  recomp: 0.85, muscle: 1.0, fat_loss: 0.8, maintain: 0.75, track: 0.7
};

// Live goals profile state ‚Äî loaded on init
let GP = JSON.parse(localStorage.getItem('fs-goals-profile') || 'null') || { ...DEFAULT_GOALS_PROFILE };

function selectGoal(type, value, btn) {
  // Single-select within group
  document.querySelectorAll(`[data-goal-type="${type}"]`).forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  GP[type] = value;
  updateProteinMultiplierPreview();
}

function toggleContextFlag(flag, btn) {
  const idx = GP.flags.indexOf(flag);
  if (idx === -1) { GP.flags.push(flag); btn.classList.add('selected-multi'); }
  else { GP.flags.splice(idx, 1); btn.classList.remove('selected-multi'); }
  updateProteinMultiplierPreview();
  updateGoalsDrivenByProfile(); // live update injection day btn visibility
}

function updateProteinMultiplierPreview() {
  const el = document.getElementById('protein-multiplier-preview');
  if (!GP.primary && !GP.activity) { el.style.display = 'none'; return; }

  const lastEvolt = S.evoltHistory.length ? S.evoltHistory[S.evoltHistory.length - 1] : null;
  const wt = lastEvolt?.wt || null;
  const bmr = lastEvolt?.bmr || null;

  const lines = [];

  if (GP.primary && wt) {
    const mult = GP.flags.includes('high_protein') ? 1.0 : (PROTEIN_MULTIPLIERS[GP.primary] || 0.8);
    const protein = Math.round(wt * mult);
    lines.push(`<strong style="color:var(--accent);">Protein ‚Üí ${protein}g/day</strong> (${mult}g √ó ${wt} lbs bodyweight)`);
  } else if (GP.primary) {
    const mult = GP.flags.includes('high_protein') ? 1.0 : (PROTEIN_MULTIPLIERS[GP.primary] || 0.8);
    lines.push(`<strong style="color:var(--accent);">Protein multiplier: ${mult}g per lb bodyweight</strong> ‚Äî enter your Evolt scan to get your number`);
  }

  if (GP.activity && bmr) {
    const actMult = ACTIVITY_MULTIPLIERS[GP.activity] || 1.35;
    const goalLabel = { recomp: '- 300 kcal (recomp deficit)', muscle: '+ 200 kcal (lean bulk)', fat_loss: '- 500 kcal (fat loss)', maintain: '(maintenance)', track: '(maintenance)' }[GP.primary] || '';
    const base = Math.round(bmr * actMult);
    const offset = { recomp: -300, muscle: 200, fat_loss: -500, maintain: 0, track: 0 }[GP.primary] || -300;
    lines.push(`<strong style="color:var(--yellow);">Calories ‚Üí ${base + offset} kcal/day</strong> (BMR ${bmr} √ó ${actMult} ${goalLabel})`);
  } else if (GP.activity) {
    lines.push(`<strong style="color:var(--yellow);">Activity multiplier: √ó${ACTIVITY_MULTIPLIERS[GP.activity]}</strong> ‚Äî enter your Evolt scan to get your calorie target`);
  }

  if (GP.flags.includes('glp1')) lines.push(`üíâ <strong>GLP-1 coaching enabled</strong> ‚Äî injection day plan + appetite override reminders active`);
  if (GP.flags.includes('resistance')) lines.push(`üèãÔ∏è <strong>Workout timing enabled</strong> ‚Äî pre/post-workout nutrition windows active`);
  if (GP.flags.includes('high_protein')) lines.push(`ü•© <strong>High protein mode</strong> ‚Äî using 1g/lb target`);

  el.style.display = lines.length ? 'block' : 'none';
  el.innerHTML = lines.join('<br>');
}

function saveGoalsProfile() {
  localStorage.setItem('fs-goals-profile', JSON.stringify(GP));

  // Recalculate numeric goals from profile + latest Evolt
  const lastEvolt = S.evoltHistory.length ? S.evoltHistory[S.evoltHistory.length - 1] : null;
  if (lastEvolt) {
    recalcGoalsFromProfile(lastEvolt);
  }

  // Apply mode switch
  applyAppMode(GP.mode || 'full');

  // Update header chips
  updateHeaderChips();

  // Update day plan button visibility (injection only if glp1 flagged)
  updateGoalsDrivenByProfile();

  const statusEl = document.getElementById('goals-profile-status');
  statusEl.style.color = 'var(--accent)';
  statusEl.textContent = '‚úÖ Profile saved! Insights and coaching will now adapt to your goals.';
  document.getElementById('goals-profile-badge').style.display = 'inline-flex';

  updateInsights(); // Refresh insights immediately
  showToast('‚úÖ Goals profile saved!');
}

function recalcGoalsFromProfile(evolt) {
  const wt = evolt?.wt, bmr = evolt?.bmr;
  if (wt && GP.primary) {
    const mult = GP.flags.includes('high_protein') ? 1.0 : (PROTEIN_MULTIPLIERS[GP.primary] || 0.8);
    S.goalProtein = Math.round(wt * mult);
    localStorage.setItem('fs-goal-protein', S.goalProtein);
  }
  if (bmr && GP.activity) {
    const actMult = ACTIVITY_MULTIPLIERS[GP.activity] || 1.35;
    const offset = { recomp: -300, muscle: 200, fat_loss: -500, maintain: 0, track: 0 }[GP.primary] || -300;
    S.goalCal = Math.round(bmr * actMult) + offset;
    localStorage.setItem('fs-goal-cal', S.goalCal);
  }
  updateGoalDisplays();
  const src = document.getElementById('goals-source');
  if (src) {
    const goalLabels = { recomp:'Body Recomp', muscle:'Build Muscle', fat_loss:'Fat Loss', maintain:'Maintain', track:'Just Track' };
    src.textContent = `From profile: ${goalLabels[GP.primary] || 'Unknown'} + Evolt ${evolt.date}`;
  }
}

function applyAppMode(mode) {
  const timingTab = document.querySelector('[onclick*="timing"]');
  const bodyTab = document.querySelector('[onclick*="body"]');
  const coachCard = document.querySelector('.coach-chips')?.closest('.card');

  if (mode === 'simple') {
    if (timingTab) timingTab.style.display = 'none';
    if (bodyTab) bodyTab.style.opacity = '0.5';
    // Collapse some UI sections
    document.getElementById('dynamic-insights').style.display = 'none';
  } else {
    if (timingTab) timingTab.style.display = '';
    if (bodyTab) bodyTab.style.opacity = '';
    document.getElementById('dynamic-insights').style.display = '';
  }
}

function updateHeaderChips() {
  const el = document.querySelector('.header-goals');
  if (!el) return;
  const goalLabels = {
    recomp: { text: '‚öñÔ∏è Recomp', cls: 'chip-muscle' },
    muscle: { text: 'üí™ Build Muscle', cls: 'chip-muscle' },
    fat_loss: { text: 'üî• Lose Fat', cls: 'chip-fat' },
    maintain: { text: 'üéØ Maintain', cls: 'chip-muscle' },
    track: { text: 'üìä Track', cls: 'chip-muscle' },
  };
  const chips = [];
  if (GP.primary) {
    const g = goalLabels[GP.primary];
    chips.push(`<span class="goal-chip ${g.cls}">${g.text}</span>`);
  }
  if (GP.flags.includes('glp1')) chips.push(`<span class="goal-chip chip-fat">üíâ GLP-1</span>`);
  if (GP.flags.includes('resistance')) chips.push(`<span class="goal-chip chip-muscle">üèãÔ∏è Training</span>`);
  if (chips.length) el.innerHTML = chips.join('');
}

function updateGoalsDrivenByProfile() {
  // Show injection day button only if GLP-1 flag is set
  const injBtn = document.querySelector('[data-plan="injection"]');
  if (injBtn) {
    injBtn.style.display = GP.flags.includes('glp1') ? '' : 'none';
  }
  // Show workout-time row only if resistance training flagged
  const wtRow = document.getElementById('workout-time-row');
  if (wtRow && !S.dayPlans.includes('workout')) {
    // keep as-is if already showing due to day plan
  }
}

function initGoalsProfileUI() {
  if (!GP.primary && !GP.activity && !GP.flags.length) return; // fresh install
  // Restore primary goal selection
  if (GP.primary) {
    const btn = document.querySelector(`[data-goal-type="primary"][data-goal="${GP.primary}"]`);
    if (btn) btn.classList.add('selected');
  }
  // Restore activity selection
  if (GP.activity) {
    const btn = document.querySelector(`[data-goal-type="activity"][data-goal="${GP.activity}"]`);
    if (btn) btn.classList.add('selected');
  }
  // Restore mode selection
  if (GP.mode) {
    const btn = document.querySelector(`[data-goal-type="mode"][data-goal="${GP.mode}"]`);
    if (btn) btn.classList.add('selected');
  }
  // Restore flags
  GP.flags.forEach(flag => {
    const btn = document.querySelector(`[data-flag="${flag}"]`);
    if (btn) btn.classList.add('selected-multi');
  });
  // Show badge
  document.getElementById('goals-profile-badge').style.display = 'inline-flex';
  // Apply mode
  applyAppMode(GP.mode || 'full');
  // Update header chips
  updateHeaderChips();
  updateGoalsDrivenByProfile();
  updateProteinMultiplierPreview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI COACH (with conversation memory)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COACH_CHIPS = ['What should I eat next?','Am I hitting my goals?','Pre-workout meal ideas?','I\'m not hungry ‚Äî help','Am I in a deficit?','What should I eat tonight?'];
let coachHistory = []; // Maintains conversation thread within session

function initCoach() {
  document.getElementById('coach-chips').innerHTML = COACH_CHIPS.map(q=>`<button class="coach-chip" onclick="askCoach('${q.replace(/'/g,"\\'")}')">${q}</button>`).join('');
}
async function askCoach(q) {
  const input = document.getElementById('coach-input');
  const question = q || input.value.trim();
  if (!question) return;
  if (!q) input.value='';
  document.getElementById('coach-loading').style.display='block';
  document.getElementById('coach-response').classList.remove('show');

  coachHistory.push({ role:'user', content:question });
  if (coachHistory.length > 8) coachHistory = coachHistory.slice(-8);

  const ctx = buildCoachContext();
  try {
    const d = await callAI({
      model:'claude-sonnet-4-5', max_tokens:500,
      system: ctx.system,
      messages: coachHistory
    });
    let txt = d.content?.[0]?.text || 'Sorry, could not get a response.';
    coachHistory.push({ role:'assistant', content: d.content?.[0]?.text || '' });
    txt = txt.replace(/\*\*(.*?)\*\*/g,'<strong style="color:var(--accent);">$1</strong>').replace(/\n/g,'<br>');
    document.getElementById('coach-response').innerHTML = txt;
    document.getElementById('coach-response').classList.add('show');
  } catch(e) {
    const msg = e.message==='NO_KEY' ? 'Add your Anthropic API key in Settings to use the AI Coach.'
              : e.message==='NO_PROXY' ? 'Add your Proxy URL in Settings to use the AI Coach.'
              : 'Error connecting ‚Äî check Settings and try again.';
    document.getElementById('coach-response').innerHTML=`<em style="color:var(--muted);">${msg}</em>`;
    document.getElementById('coach-response').classList.add('show');
    coachHistory.pop();
  }
  document.getElementById('coach-loading').style.display='none';
}
function clearCoach() {
  coachHistory = [];
  document.getElementById('coach-response').classList.remove('show');
  document.getElementById('coach-input').value='';
}
function buildCoachContext() {
  const tP=getTotalProtein(), tC=getTotalCal(), now=new Date();
  const h=now.getHours(), hf=`${h%12||12}:${String(now.getMinutes()).padStart(2,'0')} ${h>=12?'PM':'AM'}`;
  const mealSummary = MEAL_ORDER.filter(m=>S.mealLog[m]?.length).map(m=>{
    const items=S.mealLog[m]; const p=items.reduce((a,i)=>a+i.protein,0), c=items.reduce((a,i)=>a+i.cal,0);
    return `${m}: ${items.map(i=>i.displayName||i.name).join(', ')} (${p}g P, ${c} kcal)`;
  }).join('\n');
  const remaining = MEAL_ORDER.filter(m=>!S.mealLog[m]?.length);
  const training = JSON.parse(localStorage.getItem('fs-training')||'{}')[todayKey()]||null;
  const mins = minsToWorkout();
  const plan = S.dayPlans.join(' + ') || 'not set';

  // Build goal context from Goals Profile
  const goalLabels = { recomp:'Body Recomposition (build muscle + lose fat simultaneously)', muscle:'Build Muscle (primary)', fat_loss:'Fat Loss (preserve muscle)', maintain:'Maintain current composition', track:'Just tracking, no specific goal' };
  const activityLabels = { sedentary:'Sedentary (desk job)', light:'Lightly active (1-3 days/week)', moderate:'Moderately active (3-5 days/week)', very_active:'Very active (6-7 days/week)' };
  const primaryGoal = goalLabels[GP.primary] || 'Not set ‚Äî user should set their goal in Settings';
  const activityLevel = activityLabels[GP.activity] || 'Not set';
  const hasGLP1 = GP.flags.includes('glp1');
  const hasResistance = GP.flags.includes('resistance');
  const highProtein = GP.flags.includes('high_protein');
  const lowAppetite = GP.flags.includes('appetite_issues');

  // Build a goal-specific coaching persona
  let coachingFocus = '';
  if (GP.primary === 'recomp') coachingFocus = 'Focus: building muscle while losing fat. Protein is non-negotiable. Moderate caloric deficit (300-500 kcal). Prioritize post-workout nutrition.';
  else if (GP.primary === 'muscle') coachingFocus = 'Focus: maximizing muscle growth. Small caloric surplus acceptable. Protein at 1g/lb. Never miss post-workout nutrition.';
  else if (GP.primary === 'fat_loss') coachingFocus = 'Focus: fat loss while preserving muscle. Caloric deficit 400-600 kcal. Protein crucial to prevent muscle loss. Cardio supportive.';
  else if (GP.primary === 'maintain') coachingFocus = 'Focus: maintaining current composition and building sustainable habits. Caloric balance. Adequate protein.';
  else coachingFocus = 'Focus: tracking food intake and health metrics. Neutral coaching, no aggressive goals.';

  return { system:`You are a personal nutrition coach. Adapt your advice entirely to this user's specific profile.

USER GOAL PROFILE:
- Primary goal: ${primaryGoal}
- Activity level: ${activityLevel}
- On GLP-1 medication (tirzepatide/semaglutide): ${hasGLP1 ? 'YES ‚Äî appetite suppression is a key challenge' : 'No'}
- Does resistance training: ${hasResistance ? 'YES ‚Äî workout nutrition timing matters' : 'No / not specified'}
- High protein mode: ${highProtein ? 'YES ‚Äî targeting 1g per lb bodyweight' : 'No'}
- Low appetite/nausea issues: ${lowAppetite ? 'YES ‚Äî suggest soft, liquid, easy-to-eat options' : 'No'}

COACHING FOCUS: ${coachingFocus}

TODAY'S DATA (${hf}):
- Protein: ${tP}g / ${S.goalProtein}g goal (${Math.round(tP/S.goalProtein*100)}%)
- Calories: ${tC} / ${S.goalCal} kcal goal
- Water: ${S.water}oz / 80oz
- Energy: ${S.energy!==null?S.energy+'/10 '+ENERGY_LABELS[S.energy||1]:'not logged'}
- Mood: ${S.mood!==null?MOODS[S.mood].l:'not logged'}
- Fiber: ${getTotalFiber().toFixed(1)}g
- Day plan: ${plan}
${S.workoutTime?`- Workout: ${formatTime(S.workoutTime)} (${mins!==null?(mins<0?Math.abs(mins)+' min ago':mins+' min away'):'scheduled'})`:'' }
${training?`- Training: ${training.trained==='yes'?'Trained ('+training.muscles?.join(', ')+')':'Rest day'}, post-workout protein: ${training.postProtein||'not logged'}`:''}

MEALS LOGGED:
${mealSummary||'None yet'}

REMAINING MEAL SLOTS: ${remaining.join(', ')||'None'}
PROTEIN LEFT: ${Math.max(0,S.goalProtein-tP)}g
AVAILABLE FOODS: ${getAllFoods().map(f=>`${f.name} (${f.cal}kcal, ${f.protein}g P)`).join('; ')}

${hasGLP1 ? `GLP-1 COACHING NOTES:
- Tirzepatide suppresses appetite ‚Äî even when not hungry, protein must be hit
- On injection days, suggest liquid/soft proteins (Oikos Pro, cottage cheese)
- 4-5 smaller protein meals beats 1-2 large ones
- Extra hydration on injection days reduces GI side effects` : ''}

Be concise, specific, and practical. Reference their actual logged foods. Max 3-4 sentences. Adapt tone to their goal ‚Äî recomp/muscle users want performance focus, fat loss users want encouragement + accountability, trackers want neutral observations.` };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPLETE DAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCompleteDayModal() {
  const tP=getTotalProtein(), tC=getTotalCal();
  const training = JSON.parse(localStorage.getItem('fs-training')||'{}')[todayKey()]||null;

  // Default date to today
  const dateInput = document.getElementById('complete-day-date');
  dateInput.value = todayKey();
  dateInput.max = todayKey(); // Can't complete a future day
  document.getElementById('complete-date-note').style.display = 'none';
  document.getElementById('complete-today-btn').style.display = 'none';
  document.getElementById('complete-save-btn').textContent = '‚úÖ Save & Reset';

  // Populate summary using current state
  refreshCompleteModalSummary(tP, tC, training);
  document.getElementById('complete-day-modal').classList.add('open');
}

function setCompleteDateToday() {
  document.getElementById('complete-day-date').value = todayKey();
  onCompleteDateChange();
}

function onCompleteDateChange() {
  const val = document.getElementById('complete-day-date').value;
  const isToday = val === todayKey();
  const note = document.getElementById('complete-date-note');
  const todayBtn = document.getElementById('complete-today-btn');
  const saveBtn = document.getElementById('complete-save-btn');
  const saveOnlyBtn = document.getElementById('complete-save-only-btn');

  if (isToday) {
    note.style.display = 'none';
    todayBtn.style.display = 'none';
    saveBtn.textContent = '‚úÖ Save & Reset';
    saveOnlyBtn.style.display = 'none';
  } else {
    todayBtn.style.display = 'inline-flex';
    saveBtn.textContent = '‚úÖ Save & Reset';
    saveOnlyBtn.style.display = 'flex';
    const existingIdx = S.history.findIndex(e => e.isoDate === val);
    note.style.display = 'block';
    note.innerHTML = existingIdx !== -1
      ? `üìÖ Backdated entry ‚Äî <strong style="color:var(--accent2);">an entry already exists for this date and will be replaced.</strong>`
      : `üìÖ Backdated entry ‚Äî current meal data will be logged for this date.`;
  }

  if (val) {
    const d = new Date(val + 'T12:00:00');
    document.getElementById('modal-date').textContent = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  }
}

function refreshCompleteModalSummary(tP, tC, training) {
  const val = document.getElementById('complete-day-date').value;
  const d = val ? new Date(val + 'T12:00:00') : new Date();
  document.getElementById('modal-date').textContent = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});

  const pPct=Math.round(tP/S.goalProtein*100), cPct=Math.round(tC/S.goalCal*100), wPct=Math.round(S.water/80*100);
  document.getElementById('modal-stats').innerHTML=[
    {l:'Protein',v:`${tP}g`,s:`${pPct}%`,c:'var(--accent3)'},
    {l:'Calories',v:tC,s:`${cPct}%`,c:'var(--yellow)'},
    {l:'Water',v:`${S.water}oz`,s:`${wPct}%`,c:'var(--accent)'},
    {l:'Energy',v:S.energy?`${S.energy}/10`:'‚Äî',s:S.energy?ENERGY_LABELS[S.energy]:'',c:'var(--yellow)'},
  ].map(s=>`<div style="background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:11px;text-align:center;">
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:3px;">${s.l}</div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:${s.c};line-height:1;">${s.v}</div>
    <div style="font-size:10px;color:var(--muted);">${s.s}</div>
  </div>`).join('');

  const hl=[];
  if(tP>=S.goalProtein)hl.push('üèÜ Protein goal crushed!');
  else if(tP>=S.goalProtein*.8)hl.push(`üí™ ${tP}g protein ‚Äî strong effort`);
  else hl.push(`‚ö†Ô∏è ${tP}g protein ‚Äî ${S.goalProtein-tP}g short`);
  if(training?.trained==='yes')hl.push(`üèãÔ∏è Trained: ${training.muscles?.join(', ')||'Yes'}`);
  if(training?.trained==='rest')hl.push('üò¥ Rest day logged');
  if(training?.postProtein==='yes')hl.push('‚úÖ Post-workout protein hit');
  if(S.water>=80)hl.push('üíß Hydration goal met!');
  if(S.mood!=null)hl.push(`${MOODS[S.mood].e} Mood: ${MOODS[S.mood].l}`);
  document.getElementById('modal-highlights').innerHTML=hl.map(h=>`<div>${h}</div>`).join('');
}

function confirmCompleteDay(saveOnly = false) {
  const tP=getTotalProtein(), tC=getTotalCal();
  const selectedDate = document.getElementById('complete-day-date').value || todayKey();
  const isToday = selectedDate === todayKey();
  const training=JSON.parse(localStorage.getItem('fs-training')||'{}')[todayKey()]||null;

  const displayDate = new Date(selectedDate + 'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});

  const entry = {
    date: displayDate,
    isoDate: selectedDate,
    protein:tP, cal:tC, water:S.water, energy:S.energy,
    mood:S.mood!=null?MOODS[S.mood].e:null,
    trained:training?.trained||null, muscles:training?.muscles||[],
    postProtein:training?.postProtein||null, dayPlans:S.dayPlans,
  };

  const existingIdx = S.history.findIndex(e => e.isoDate === selectedDate);
  if (existingIdx !== -1) S.history.splice(existingIdx, 1, entry);
  else S.history.unshift(entry);

  S.history.sort((a,b) => {
    const da=a.isoDate||'0000-00-00', db=b.isoDate||'0000-00-00';
    return da<db?1:da>db?-1:0;
  });
  if(S.history.length>90) S.history=S.history.slice(0,90);
  localStorage.setItem('fs-history',JSON.stringify(S.history));

  closeModal('complete-day-modal');
  renderHistory();

  const shouldReset = !saveOnly; // always reset if "Save & Reset" clicked
  if (shouldReset) {
    showToast(isToday ? 'üèÅ Day saved!' : `üìÖ Entry saved for ${displayDate} ‚Äî resetting today`);
    setTimeout(()=>{ resetDailyState(false); if(driveConnected)syncToDrive(); }, 1200);
  } else {
    showToast(`üíæ Entry saved for ${displayDate}`);
    if(driveConnected) setTimeout(()=>syncToDrive(), 800);
  }
}
function renderHistory() {
  const el=document.getElementById('history-list');
  if(!S.history.length){el.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:40px;">Complete your first day to start tracking!</div>';return;}
  el.innerHTML=S.history.map(e=>`
    <div class="log-entry">
      <div class="log-date">${e.date}</div>
      <div class="log-chips">
        <span class="log-chip">Protein: <strong>${e.protein}g</strong></span>
        <span class="log-chip">Calories: <strong>${e.cal}</strong></span>
        <span class="log-chip">Water: <strong>${e.water}oz</strong></span>
        ${e.energy?`<span class="log-chip">Energy: <strong>${e.energy}/10</strong></span>`:''}
        ${e.mood?`<span class="log-chip">Mood: <strong>${e.mood}</strong></span>`:''}
        ${e.trained==='yes'?`<span class="log-chip">Trained: <strong>üí™${e.muscles?.length?' '+e.muscles.join(', '):''}</strong></span>`:''}
        ${e.trained==='rest'?`<span class="log-chip">Training: <strong>üò¥ Rest</strong></span>`:''}
        ${e.postProtein==='yes'?`<span class="log-chip">Post-WO P: <strong>‚úÖ</strong></span>`:''}
        ${e.postProtein==='no'?`<span class="log-chip">Post-WO P: <strong>‚ùå</strong></span>`:''}
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveApiKey() {
  const key = document.getElementById('anthropic-key').value.trim();
  localStorage.setItem('fs-anthropic-key', key);
  const el = document.getElementById('key-status');
  if (key.startsWith('sk-ant-')) { el.style.color='var(--accent)'; el.textContent='‚úÖ Key saved ‚Äî persists across sessions'; }
  else if (key) { el.style.color='var(--accent2)'; el.textContent='‚ö†Ô∏è Key should start with sk-ant-...'; }
  else { el.textContent=''; }
}
function toggleKeyVis() {
  const inp = document.getElementById('anthropic-key');
  const eye = document.getElementById('key-eye');
  inp.type = inp.type==='password'?'text':'password';
  eye.textContent = inp.type==='password'?'üëÅ':'üôà';
}
function saveProxyUrl() {
  const url = document.getElementById('proxy-url').value.trim();
  localStorage.setItem('fs-proxy-url', url);
  const el = document.getElementById('proxy-status');
  if (url.startsWith('https://') && url.includes('workers.dev')) {
    el.style.color='var(--accent)'; el.textContent='‚úÖ Proxy URL saved';
  } else if (url.startsWith('https://')) {
    el.style.color='var(--accent)'; el.textContent='‚úÖ Proxy URL saved';
  } else if (url) {
    el.style.color='var(--accent2)'; el.textContent='‚ö†Ô∏è URL should start with https://';
  } else { el.textContent=''; }
}
function saveDriveCreds() {
  const cid = document.getElementById('gapi-client-id').value.trim();
  if (cid) localStorage.setItem('fs-gapi-client-id', cid);
}
function initSettings() {
  const cid = localStorage.getItem('fs-gapi-client-id')||DEFAULT_CLIENT_ID;
  localStorage.setItem('fs-gapi-client-id',cid);
  const el = document.getElementById('gapi-client-id');
  if (el) el.value = cid;
  // Restore API key
  const key = localStorage.getItem('fs-anthropic-key')||'';
  if (key) {
    document.getElementById('anthropic-key').value = key;
    if (key.startsWith('sk-ant-')) { document.getElementById('key-status').style.color='var(--accent)'; document.getElementById('key-status').textContent='‚úÖ Key saved ‚Äî persists across sessions'; }
  }
  // Restore proxy URL
  const proxy = localStorage.getItem('fs-proxy-url')||'';
  if (proxy) {
    document.getElementById('proxy-url').value = proxy;
    document.getElementById('proxy-status').style.color='var(--accent)';
    document.getElementById('proxy-status').textContent='‚úÖ Proxy URL saved';
  }
  document.getElementById('goal-protein-input').value = S.goalProtein;
  document.getElementById('goal-cal-input').value = S.goalCal;
  if (S.evoltHistory.length) {
    const last = S.evoltHistory[S.evoltHistory.length-1];
    document.getElementById('goals-source').textContent = `Auto-set from Evolt scan on ${last.date}`;
  }
}
function confirmClearAll() {
  if (confirm('Clear ALL data? This cannot be undone.')) {
    ['fs-water','fs-energy','fs-mood','fs-meals','fs-history','fs-evolt','fs-custom-foods','fs-today','fs-dayplans','fs-workouttime','fs-training','fs-goal-protein','fs-goal-cal','fs-goals-profile'].forEach(k=>localStorage.removeItem(k));
    location.reload();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANTHROPIC HEADERS HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI PROXY ‚Äî all Anthropic calls go through the worker
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function callAI(payload) {
  const key   = localStorage.getItem('fs-anthropic-key') || '';
  const proxy = localStorage.getItem('fs-proxy-url') || '';

  if (!key)   throw new Error('NO_KEY');
  if (!proxy) throw new Error('NO_PROXY');

  const r = await fetch(proxy.replace(/\/$/, '') + '/proxy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ key, payload }),
  });

  if (!r.ok) {
    const err = await r.json().catch(() => ({}));
    throw new Error(err.error || `HTTP ${r.status}`);
  }
  return r.json();
}

// Legacy shim ‚Äî kept so old call sites compile (not used for headers anymore)
function anthropicHeaders() {
  return { 'Content-Type': 'application/json' };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT / IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildPayload() {
  return {
    version:3, exportedAt:new Date().toISOString(), savedDate:todayKey(),
    history:S.history, evoltHistory:S.evoltHistory, customFoods:S.customFoods,
    mealLog:S.mealLog, water:S.water, energy:S.energy, mood:S.mood,
    moodNotes:document.getElementById('mood-notes')?.value||'',
    training:JSON.parse(localStorage.getItem('fs-training')||'{}'),
    dayPlans:S.dayPlans, workoutTime:S.workoutTime,
    goalProtein:S.goalProtein, goalCal:S.goalCal,
    goalsProfile: GP,
    anthropicKey:localStorage.getItem('fs-anthropic-key')||'',
  };
}
function applyPayload(data) {
  if (data.history) { S.history=data.history; localStorage.setItem('fs-history',JSON.stringify(S.history)); }
  if (data.evoltHistory) { S.evoltHistory=data.evoltHistory; localStorage.setItem('fs-evolt',JSON.stringify(S.evoltHistory)); }
  if (data.customFoods) { S.customFoods=data.customFoods; localStorage.setItem('fs-custom-foods',JSON.stringify(S.customFoods)); }
  // Only restore today's live data if from same date
  if (data.savedDate === todayKey()) {
    if (data.mealLog) { S.mealLog=data.mealLog; localStorage.setItem('fs-meals',JSON.stringify(S.mealLog)); }
    if (data.water!=null) { S.water=data.water; localStorage.setItem('fs-water',S.water); }
    if (data.energy!=null) { S.energy=data.energy; localStorage.setItem('fs-energy',S.energy); }
    if (data.mood!=null) { S.mood=data.mood; localStorage.setItem('fs-mood',S.mood); }
    if (data.dayPlans) { S.dayPlans=data.dayPlans; localStorage.setItem('fs-dayplans',JSON.stringify(S.dayPlans)); }
    if (data.workoutTime) { S.workoutTime=data.workoutTime; localStorage.setItem('fs-workouttime',S.workoutTime); }
  }
  if (data.training) localStorage.setItem('fs-training',JSON.stringify(data.training));
  if (data.goalProtein) { S.goalProtein=data.goalProtein; localStorage.setItem('fs-goal-protein',S.goalProtein); }
  if (data.goalCal) { S.goalCal=data.goalCal; localStorage.setItem('fs-goal-cal',S.goalCal); }
  if (data.goalsProfile) { GP = data.goalsProfile; localStorage.setItem('fs-goals-profile', JSON.stringify(GP)); initGoalsProfileUI(); }
  if (data.anthropicKey) { localStorage.setItem('fs-anthropic-key',data.anthropicKey); document.getElementById('anthropic-key').value=data.anthropicKey; }
  renderAll();
}
function exportData() {
  const blob = new Blob([JSON.stringify(buildPayload(),null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download=`fuelstrong-${todayKey()}.json`; a.click();
  URL.revokeObjectURL(a.href); showToast('‚úÖ Exported!');
}
function importData(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { try { applyPayload(JSON.parse(ev.target.result)); showToast('‚úÖ Data imported!'); } catch { showToast('‚ùå Invalid file'); } };
  reader.readAsText(file); e.target.value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE DRIVE SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let driveToken=null, driveFolderId=localStorage.getItem('fs-drive-folder-id')||null, driveFileId=localStorage.getItem('fs-drive-file-id')||null, driveConnected=false;

async function handleDriveAuth() {
  const cid = localStorage.getItem('fs-gapi-client-id')||DEFAULT_CLIENT_ID;
  if (!cid) { showToast('Paste your Google Client ID in Settings first'); return; }
  try {
    google.accounts.oauth2.initTokenClient({
      client_id:cid, scope:'https://www.googleapis.com/auth/drive.file',
      callback: async resp => {
        if (resp.error) { showToast('‚ùå Auth failed: '+resp.error); return; }
        driveToken=resp.access_token; driveConnected=true;
        localStorage.setItem('fs-drive-connected','1');
        updateDriveUI(true);
        await ensureDriveFolder();
        await syncToDrive();
        showToast('‚úÖ Google Drive connected!');
      }
    }).requestAccessToken({ prompt:'' });
  } catch(e) { showToast('‚ùå Auth error ‚Äî check Client ID'); }
}
function disconnectDrive() {
  driveToken=null; driveConnected=false;
  localStorage.removeItem('fs-drive-connected');
  updateDriveUI(false); showToast('Drive disconnected');
}
function updateDriveUI(connected) {
  const badge=document.getElementById('drive-badge'), setup=document.getElementById('drive-setup'), panel=document.getElementById('drive-connected'), btn=document.getElementById('drive-btn'), label=document.getElementById('drive-label');
  if (connected) {
    badge.textContent='‚úì Connected'; badge.style.background='rgba(0,229,160,.12)'; badge.style.color='var(--accent)';
    if(setup)setup.style.display='none'; if(panel)panel.style.display='block';
    if(btn){btn.style.borderColor='rgba(0,229,160,.3)';btn.style.color='var(--accent)';} if(label)label.textContent='Synced ‚úì';
  } else {
    badge.textContent='Not connected'; badge.style.background='var(--card2)'; badge.style.color='var(--muted)';
    if(setup)setup.style.display='block'; if(panel)panel.style.display='none';
    if(btn){btn.style.borderColor='';btn.style.color='';} if(label)label.textContent='Connect Drive';
  }
}
async function driveReq(url, opts={}) {
  const r = await fetch(url,{...opts,headers:{'Authorization':'Bearer '+driveToken,...(opts.headers||{})}});
  if (!r.ok) throw new Error('Drive '+r.status);
  return r.json();
}
async function ensureDriveFolder() {
  if (driveFolderId) return driveFolderId;
  const q = encodeURIComponent(`name='FuelStrong' and mimeType='application/vnd.google-apps.folder' and trashed=false`);
  const res = await driveReq(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`);
  if (res.files?.length) { driveFolderId=res.files[0].id; }
  else { const c=await driveReq('https://www.googleapis.com/drive/v3/files',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:'FuelStrong',mimeType:'application/vnd.google-apps.folder'})}); driveFolderId=c.id; }
  localStorage.setItem('fs-drive-folder-id',driveFolderId);
  return driveFolderId;
}
async function syncToDrive() {
  if (!driveToken) { showToast('Connect Drive first'); return; }
  try {
    const folderId=await ensureDriveFolder();
    const blob=new Blob([JSON.stringify(buildPayload(),null,2)],{type:'application/json'});
    if (!driveFileId) {
      const q=encodeURIComponent(`name='fuelstrong-data.json' and '${folderId}' in parents and trashed=false`);
      const r=await driveReq(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`);
      if (r.files?.length) { driveFileId=r.files[0].id; localStorage.setItem('fs-drive-file-id',driveFileId); }
    }
    const form=new FormData();
    if (driveFileId) {
      form.append('metadata',new Blob([JSON.stringify({name:'fuelstrong-data.json'})],{type:'application/json'}));
      form.append('file',blob);
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`,{method:'PATCH',headers:{'Authorization':'Bearer '+driveToken},body:form});
    } else {
      form.append('metadata',new Blob([JSON.stringify({name:'fuelstrong-data.json',parents:[folderId]})],{type:'application/json'}));
      form.append('file',blob);
      const r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',headers:{'Authorization':'Bearer '+driveToken},body:form});
      const c=await r.json(); driveFileId=c.id; localStorage.setItem('fs-drive-file-id',driveFileId);
    }
    const now=new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const syncEl=document.getElementById('drive-last-sync');
    if(syncEl)syncEl.textContent=`Last synced: ${now}`;
    showToast('‚òÅÔ∏è Synced to Drive!');
  } catch(e) { showToast('‚ùå Sync failed: '+e.message); }
}
async function loadFromDrive() {
  if (!driveToken) { showToast('Connect Drive first'); return; }
  try {
    showToast('üì• Loading...');
    const folderId=await ensureDriveFolder();
    if (!driveFileId) {
      const q=encodeURIComponent(`name='fuelstrong-data.json' and '${folderId}' in parents and trashed=false`);
      const r=await driveReq(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`);
      if (!r.files?.length) { showToast('No data found on Drive'); return; }
      driveFileId=r.files[0].id; localStorage.setItem('fs-drive-file-id',driveFileId);
    }
    const resp=await fetch(`https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`,{headers:{'Authorization':'Bearer '+driveToken}});
    applyPayload(await resp.json());
    showToast('‚úÖ Loaded from Drive!');
  } catch(e) { showToast('‚ùå Load failed: '+e.message); }
}
async function autoReconnectDrive() {
  if (!localStorage.getItem('fs-drive-connected')) return;
  const cid=localStorage.getItem('fs-gapi-client-id')||DEFAULT_CLIENT_ID;
  try {
    google.accounts.oauth2.initTokenClient({
      client_id:cid, scope:'https://www.googleapis.com/auth/drive.file', prompt:'none',
      callback: async resp => {
        if (resp.error) return;
        driveToken=resp.access_token; driveConnected=true;
        updateDriveUI(true);
        await loadFromDriveQuiet();
      }
    }).requestAccessToken({ prompt:'none' });
  } catch(e){}
}
async function loadFromDriveQuiet() {
  if (!driveToken) return;
  try {
    const folderId=await ensureDriveFolder();
    if (!driveFileId) {
      const q=encodeURIComponent(`name='fuelstrong-data.json' and '${folderId}' in parents and trashed=false`);
      const r=await driveReq(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,modifiedTime)`);
      if (!r.files?.length) return;
      driveFileId=r.files[0].id; localStorage.setItem('fs-drive-file-id',driveFileId);
    }
    const driveTs=await driveReq(`https://www.googleapis.com/drive/v3/files/${driveFileId}?fields=modifiedTime`);
    const localTs=+localStorage.getItem('fs-last-save')||0;
    if (new Date(driveTs.modifiedTime).getTime()>localTs) {
      const resp=await fetch(`https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`,{headers:{'Authorization':'Bearer '+driveToken}});
      applyPayload(await resp.json());
    }
  } catch(e){}
}
let syncTimer=null;
function scheduleSync() { if (!driveConnected) return; clearTimeout(syncTimer); syncTimer=setTimeout(()=>syncToDrive(),3000); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE / AUTOSAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save() {
  localStorage.setItem('fs-meals',JSON.stringify(S.mealLog));
  localStorage.setItem('fs-water',S.water);
  if (S.energy!==null) localStorage.setItem('fs-energy',S.energy);
  if (S.mood!==null) localStorage.setItem('fs-mood',S.mood);
  localStorage.setItem('fs-dayplans',JSON.stringify(S.dayPlans));
  if (S.workoutTime) localStorage.setItem('fs-workouttime',S.workoutTime);
  localStorage.setItem('fs-last-save',Date.now());
  scheduleSync();
}
function autoSave() { save(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastT;
function showToast(msg) {
  clearTimeout(removeTimer); pendingRemove = null;
  const t = document.getElementById('toast');
  t.innerHTML = ''; t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastT); toastT = setTimeout(() => t.classList.remove('show'), 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() {
  renderWater(); renderMood(); renderMealLog(); updateTotals();
  renderHistory(); renderEvoltHistory(); renderFoodList(getAllFoods());
  updateGoalDisplays(); updateSavedBtn(); renderDayPlanBtns();
  updateInsights(); updateSimpleMode();
  if (S.workoutTime) { document.getElementById('workout-time').value=S.workoutTime; updateWorkoutStatus(); }
  if (S.dayPlans.includes('workout')) document.getElementById('workout-time-row').style.display='block';
  if (S.energy!==null) { document.getElementById('energy-slider').value=S.energy; updateEnergy(S.energy); }
  const notes=localStorage.getItem('fs-mood-notes')||''; if(notes)document.getElementById('mood-notes').value=notes;
  renderTodaySummary();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAB + QUICK-ADD BOTTOM SHEET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleQuickSheet() {
  const sheet = document.getElementById('quick-sheet');
  if (sheet.classList.contains('show')) closeQuickSheet();
  else openQuickSheet();
}
function openQuickSheet() {
  // Sync meal selector with main food log selector
  const mainTarget = document.getElementById('meal-target')?.value || 'Breakfast';
  document.getElementById('sheet-meal-target').value = mainTarget;
  renderSheetChips();
  renderSheetFoodList(getAllFoods());
  document.getElementById('sheet-search').value = '';
  document.getElementById('quick-sheet').classList.add('show');
  document.getElementById('fab').classList.add('open');
  document.getElementById('fab').title = 'Close';
  setTimeout(() => document.getElementById('sheet-search').focus(), 350);
}
function closeQuickSheet() {
  document.getElementById('quick-sheet').classList.remove('show');
  document.getElementById('fab').classList.remove('open');
  document.getElementById('fab').title = 'Quick Add Food';
}
function renderSheetChips() {
  // Show the top ~12 most used / highest protein foods as chips
  const foods = getAllFoods().slice(0, 12);
  const el = document.getElementById('sheet-food-chips');
  el.innerHTML = foods.map(f => `
    <div class="quick-chip" onclick="sheetAddFood(${JSON.stringify(f).replace(/"/g,'&quot;')})">
      <span style="font-size:18px;">${f.icon || 'üçΩ'}</span>
      <span class="quick-chip-name">${f.name.split(' ').slice(0,3).join(' ')}</span>
      <span class="quick-chip-p">${f.protein}g P</span>
    </div>`).join('');
}
function filterSheetFoods() {
  const q = document.getElementById('sheet-search').value.toLowerCase().trim();
  const filtered = q ? getAllFoods().filter(f => f.name.toLowerCase().includes(q)) : getAllFoods();
  renderSheetFoodList(filtered);
}
function renderSheetFoodList(foods) {
  const el = document.getElementById('sheet-food-list');
  el.innerHTML = foods.slice(0, 20).map(f => `
    <div style="display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 12px;gap:8px;">
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${f.icon||'üçΩ'} ${f.name}</div>
        <div style="font-size:11px;color:var(--muted);">${f.cal} kcal ¬∑ <span style="color:var(--accent3);">${f.protein}g P</span></div>
      </div>
      <button class="btn btn-primary btn-sm" style="flex-shrink:0;" onclick="sheetAddFood(${JSON.stringify(f).replace(/"/g,'&quot;')})">Add</button>
    </div>`).join('') || '<div style="color:var(--muted);text-align:center;padding:16px;font-size:13px;">No foods found</div>';
}
function sheetAddFood(food) {
  // Sync selected meal from sheet selector
  const meal = document.getElementById('sheet-meal-target').value;
  document.getElementById('meal-target').value = meal;
  addToMeal(food, 1);
  // Flash the chip
  closeQuickSheet();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIMPLE MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyAppMode(mode) {
  const isSimple = mode === 'simple';
  document.body.classList.toggle('simple-mode', isSimple);

  // Show/hide timing tab
  const timingTab = document.querySelector('.tab[onclick*="timing"]');
  if (timingTab) timingTab.style.display = isSimple ? 'none' : '';

  // Show/hide body/Evolt tab in simple mode
  const bodyTab = document.querySelector('.tab[onclick*="body"]');
  if (bodyTab) bodyTab.style.opacity = isSimple ? '0.5' : '';

  if (isSimple) {
    // If currently on timing tab, switch to today
    if (document.getElementById('tab-timing')?.classList.contains('active')) {
      switchTab('today', document.querySelector('.tab[onclick*="today"]'));
    }
    updateSimpleMode();
  } else {
    // Ensure full mode dynamic insights are visible
    const di = document.getElementById('dynamic-insights');
    if (di) di.style.display = '';
    updateInsights();
  }

  // Sync injection btn visibility with GLP-1 flag
  document.querySelectorAll('.simple-injection-btn').forEach(b => {
    b.style.display = GP.flags.includes('glp1') ? '' : 'none';
  });
}

function updateSimpleMode() {
  if (!document.body.classList.contains('simple-mode')) return;
  const tP = getTotalProtein(), tC = getTotalCal();

  // Stats
  document.getElementById('s-protein').textContent = tP;
  document.getElementById('s-protein-goal').textContent = S.goalProtein;
  document.getElementById('s-cal').textContent = tC;
  document.getElementById('s-cal-goal').textContent = S.goalCal;
  document.getElementById('s-water').textContent = S.water;
  document.getElementById('s-protein-bar').style.width = Math.min(100, Math.round(tP/S.goalProtein*100)) + '%';
  document.getElementById('s-cal-bar').style.width = Math.min(100, Math.round(tC/S.goalCal*100)) + '%';
  document.getElementById('s-water-bar').style.width = Math.min(100, Math.round(S.water/80*100)) + '%';

  // Meal summary (compact)
  const sm = document.getElementById('simple-meal-summary');
  const entries = [];
  MEAL_ORDER.forEach(meal => {
    (S.mealLog[meal]||[]).forEach(item => entries.push({ meal, item }));
  });
  if (!entries.length) {
    sm.innerHTML = '<div style="color:var(--muted);font-size:13px;text-align:center;padding:14px;">No meals logged ‚Äî tap Ôºã to add food</div>';
  } else {
    // Group by meal
    const groups = {};
    MEAL_ORDER.forEach(m => { if (S.mealLog[m]?.length) groups[m] = S.mealLog[m]; });
    sm.innerHTML = Object.entries(groups).map(([meal, items]) => {
      const mP = items.reduce((a,i)=>a+i.protein,0);
      const mC = items.reduce((a,i)=>a+i.cal,0);
      return `<div style="padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
          <span style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);">${meal}</span>
          <span style="font-size:11px;font-family:'DM Mono',monospace;color:var(--accent3);">${mP}g P ¬∑ ${mC} kcal</span>
        </div>
        <div style="font-size:13px;">${items.map(i=>`${i.icon||'üçΩ'} ${i.displayName||i.name}`).join(' ¬∑ ')}</div>
      </div>`;
    }).join('') + `<div style="padding-top:8px;display:flex;justify-content:space-between;font-size:12px;color:var(--muted);">
      <span>Total</span>
      <span style="font-family:'DM Mono',monospace;"><span style="color:var(--accent3);">${tP}g P</span> ¬∑ ${tC} kcal</span>
    </div>`;
  }

  // Single smart insight
  const ic = document.getElementById('simple-insight-card');
  const proteinLeft = Math.max(0, S.goalProtein - tP);
  const remaining = MEAL_ORDER.filter(m => !(S.mealLog[m]?.length)).length;
  let insight;
  if (tP >= S.goalProtein) {
    insight = { icon:'üèÜ', color:'var(--accent)', bg:'rgba(0,229,160,.08)', border:'rgba(0,229,160,.2)', text:`<strong>Protein goal hit!</strong> ${tP}g logged. ${tC <= S.goalCal ? 'Calories on track too ‚Äî great day.' : `Watch calories ‚Äî ${tC-S.goalCal} kcal over goal.`}` };
  } else if (remaining > 0) {
    const perMeal = Math.ceil(proteinLeft / remaining);
    insight = { icon:'üìä', color:'var(--yellow)', bg:'rgba(255,212,96,.07)', border:'rgba(255,212,96,.2)', text:`<strong>${proteinLeft}g protein left</strong> across ${remaining} meal slot${remaining!==1?'s':''}. Aim for ~${perMeal}g per meal.` };
  } else {
    insight = { icon:'‚ö†Ô∏è', color:'var(--accent2)', bg:'rgba(255,107,53,.08)', border:'rgba(255,107,53,.2)', text:`<strong>${proteinLeft}g short</strong> of your protein goal. Add a quick protein snack.` };
  }
  ic.style.background = insight.bg;
  ic.style.border = `1px solid ${insight.border}`;
  ic.innerHTML = `<div style="display:flex;gap:10px;align-items:flex-start;">
    <span style="font-size:20px;">${insight.icon}</span>
    <div style="font-size:13px;line-height:1.6;color:var(--text);">${insight.text}</div>
  </div>`;

  // Sync day plan buttons in simple view
  renderSimpleDayPlanBtns();
}

function renderSimpleDayPlanBtns() {
  document.querySelectorAll('#simple-day-plan-btns .day-plan-btn').forEach(b => {
    const active = S.dayPlans.includes(b.dataset.plan);
    b.classList.toggle('btn-primary', active);
    b.classList.toggle('btn-ghost', !active);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init() {
  checkNewDay();
  initDate();
  initTiming();
  initCoach();
  initSettings();
  initGoalsProfileUI(); // restore Goals Profile UI state
  renderAll();

  // Set today's date in meal time input
  const now=new Date();
  document.getElementById('meal-time').value=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  document.getElementById('ev-date').value=todayKey();

  // Refresh workout status + insights every minute
  setInterval(()=>{ updateWorkoutStatus(); updateInsights(); },60000);

  // Auto-reconnect Drive
  setTimeout(()=>autoReconnectDrive(),1500);

  // Set up mood notes saving
  document.getElementById('mood-notes').addEventListener('input', ()=>{ localStorage.setItem('fs-mood-notes',document.getElementById('mood-notes').value); });

  // Restore last evolt for goals preview
  if (S.evoltHistory.length) {
    const last=S.evoltHistory[S.evoltHistory.length-1];
    const src=document.getElementById('goals-source');
    if(src)src.textContent=`Auto-set from Evolt scan on ${last.date}`;
  }
}
init();
</script>
</body>
</html>
